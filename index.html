<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arendator.kg — свежие квартиры без посредников</title>
  <meta name="description" content="Свежие объявления аренды от владельцев. Анти-агент фильтр, номера открываются после оплаты. Объявления живут 24 часа." />
  <link rel="icon" href="./images/Arendatorkg.png">
  <link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--container:1180px; --ads:110px}
    .container{max-width:var(--container)}
    .shadow-soft{box-shadow:0 8px 30px rgba(0,0,0,.08)}
    html,body{overflow-x:hidden;font-family:'Onest',system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;font-weight:400}
    .hero-title{font-weight:800}
    header .container>*{position:relative;z-index:10}
    .side-ads{position:fixed;top:60px;bottom:0;width:var(--ads);display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:5}
    .side-ads>div{writing-mode:vertical-rl;transform:rotate(180deg);opacity:.75}
    @media (max-width:1400px){.side-ads{display:none}}
    .card-actions{display:flex;gap:.5rem;align-items:center}
    .card-actions>input{min-width:0}
    .mask-blur{filter:blur(3px)}
    .dropdown{position:relative}
    /* Важная правка: плашки аккаунта поверх ПРОДАЖА/БЛОГ/ИЗБРАННОЕ на мобилке */
    .dropdown-menu{position:absolute;right:0;top:calc(100% + .5rem);min-width:220px;z-index:60}
    .user-avatar{width:32px;height:32px;border-radius:9999px;background:#e5e7eb;color:#374151;display:grid;place-items:center;font-weight:700;overflow:hidden;background-size:cover;background-position:center;flex-shrink:0;font-size:14px;cursor:pointer}
    .avatar-lg{width:96px;height:96px;border-radius:9999px;background:#e5e7eb;display:grid;place-items:center;overflow:hidden;background-size:cover;background-position:center;font-weight:800;font-size:36px;color:#374151;margin:0 auto}
    .nav-mobile a{font-size:13px}
    .lang-toggle{padding:.25rem .5rem;border:1px solid rgb(229 231 235);border-radius:.75rem}
    .lang-toggle span{opacity:.55}
    .lang-toggle .active{opacity:1;font-weight:700}

    /* Стиль старой плашки Снять/Купить (оставлено для совместимости) */
    .seg{display:grid;grid-template-columns:1fr 1fr;border:1px solid rgb(229 231 235);border-radius:0.75rem;overflow:hidden}
    .seg button{padding:.5rem .75rem;font-weight:600}
    .seg button.active{background:#111827;color:#fff}
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900">

  <div class="bg-emerald-600 text-white text-center text-xs sm:text-sm py-2">
    Объявления живут 24 часа · Анти-агент фильтр включён
  </div>

  <aside class="side-ads left-0"><div class="rounded-2xl bg-white border border-neutral-200 shadow-soft px-2 py-4 text-sm">Реклама</div></aside>
  <aside class="side-ads right-0"><div class="rounded-2xl bg-white border border-neutral-200 shadow-soft px-2 py-4 text-sm">Реклама</div></aside>

  <header class="bg-white sticky top-0 z-30 border-b border-neutral-100/80">
    <div class="container mx-auto px-4 py-2 md:py-3 flex flex-col gap-2">

      <!-- Моб. строка -->
      <div class="flex items-center justify-between md:hidden">
        <a href="/" class="flex items-center gap-2 shrink-0">
          <img src="./images/Arendatorkg.png" alt="Arendator.kg" class="w-8 h-8 rounded-full object-contain">
        </a>
        <button id="langToggleMobile" class="lang-toggle text-sm">
          <span class="ru active">Рус</span> / <span class="ky">Кыр</span>
        </button>
        <div class="flex items-center gap-2 dropdown" id="accountAreaMobile">
          <button id="btnAuthMobile" class="text-blue-600 text-sm hover:underline">Вход / регистрация</button>
          <div id="userBadgeMobile" class="hidden items-center">
            <div id="userAvatarMobile" class="user-avatar" title="Мой аккаунт"></div>
          </div>
          <div id="accountMenuMobile" class="dropdown-menu hidden bg-white border border-neutral-200 rounded-xl shadow-soft p-1">
            <button id="menuMyAdsM" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50">Мои объявления</button>
            <button id="menuEditProfileM" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50">Редактировать профиль</button>
            <button id="menuChangeAvatarM" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50">Изменить аватарку</button>
            <div class="h-px bg-neutral-200 my-1"></div>
            <button id="menuLogoutM" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50 text-red-600">Выйти</button>
          </div>
        </div>
      </div>

      <nav class="md:hidden nav-mobile flex flex-wrap items-center gap-3">
        <a href="post.html" class="px-3 py-1.5 rounded-xl bg-neutral-900 text-white hover:bg-neutral-800 whitespace-nowrap">Добавить объявление</a>
        <a href="sell.html" class="hover:text-blue-600 whitespace-nowrap">Продажа</a>
        <a href="blog.html" class="hover:text-blue-600 whitespace-nowrap">Блог</a>
        <a href="favorites.html" class="hover:text-blue-600 whitespace-nowrap">Избранное</a>
      </nav>

      <!-- Десктоп строка -->
      <div class="hidden md:flex items-center gap-4">
        <a href="/" class="flex items-center gap-2 shrink-0">
          <img src="./images/Arendatorkg.png" alt="Arendator.kg" class="w-8 h-8 rounded-full object-contain">
        </a>

        <nav class="flex items-center gap-4 text-sm">
          <a href="post.html" class="px-3 py-1.5 rounded-xl bg-neutral-900 text-white hover:bg-neutral-800 whitespace-nowrap">Добавить объявление</a>
          <a href="sell.html" class="hover:text-blue-600 whitespace-nowrap">Продажа</a>
          <a href="blog.html" class="hover:text-blue-600 whitespace-nowrap">Блог</a>
          <a href="favorites.html" class="hover:text-blue-600 whitespace-nowrap">Избранное</a>
        </nav>

        <div class="flex-1"></div>

        <button id="langToggle" class="lang-toggle text-sm">
          <span class="ru active">Рус</span> / <span class="ky">Кыр</span>
        </button>

        <div class="flex items-center gap-3 text-sm dropdown" id="accountArea">
          <button id="btnAuth" class="text-blue-600 hover:underline">Вход / регистрация</button>
          <div id="userBadge" class="hidden items-center">
            <div id="userAvatar" class="user-avatar" title="Мой аккаунт"></div>
          </div>
          <div id="accountMenu" class="dropdown-menu hidden bg-white border border-neutral-200 rounded-xl shadow-soft p-1">
            <button id="menuMyAds" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50">Мои объявления</button>
            <button id="menuEditProfile" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50">Редактировать профиль</button>
            <button id="menuChangeAvatar" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50">Изменить аватарку</button>
            <div class="h-px bg-neutral-200 my-1"></div>
            <button id="menuLogout" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50 text-red-600">Выйти</button>
          </div>
        </div>
      </div>

    </div>
  </header>

  <!-- Герой и остальная верстка -->
  <section class="container mx-auto px-4 pt-8">
    <div class="grid md:grid-cols-2 gap-8 items-stretch">
      <div class="bg-white border border-neutral-200 rounded-2xl shadow-soft p-4 sm:p-5 h-full flex flex-col">
        <h1 class="hero-title text-3л md:text-5xl leading-tight text-blue-600">Ищете квартиру в аренду?</h1>
        <p class="mt-3 text-base md:text-lg text-neutral-600">Объявления обновляются каждую секунду из 30 источников. Только свежие — жильё за день!</p>

        <div class="mt-5 grid grid-cols-2 gap-3">
          <!-- Снять / Купить как выпадающий пункт -->
          <select id="dealSelect" class="col-span-2 px-3 py-2 rounded-xl border border-neutral-200">
            <option value="rent">Снять</option>
            <option value="buy">Купить</option>
          </select>

          <select id="s2" class="px-3 py-2 rounded-xl border border-neutral-200">
            <option>Квартира</option><option>Комната</option><option>Дом</option>
          </select>

          <!-- Области внутри плашки, отдельно Бишкек -->
          <select id="s3" class="px-3 py-2 rounded-xl border border-neutral-200">
            <optgroup label="Город">
              <option>Бишкек</option>
            </optgroup>
            <optgroup label="Области">
              <option>Чуйская область</option>
              <option>Иссык-Кульская область</option>
              <option>Таласская область</option>
              <option>Нарынская область</option>
              <option>Джалал-Абадская область</option>
              <option>Ошская область</option>
              <option>Баткенская область</option>
            </optgroup>
          </select>

          <!-- Полный список районов Бишкек -->
          <select id="s4" class="px-3 py-2 rounded-xl border border-neutral-200">
            <option selected>Бишкек (все районы)</option>

            <optgroup label="Ленинский район">
              <option>Азия Молл</option><option>Ак Кеме</option><option>Ак-Орго ж/м</option><option>Ак-Ордо ж/м</option>
              <option>Академия Наук</option><option>Ала-Тоо 3 ж-м</option><option>Ала-Тоо м-н</option><option>Арча-Бешик ж/м</option>
              <option>Баха</option><option>БГУ</option><option>Верхний Джал м-н</option><option>Гагарина</option>
              <option>Госрегистр</option><option>Джал 15 м-н</option><option>Джал-23 м-н (Нижний Джал)</option>
              <option>Джал-29 м-н</option><option>Джал-30 м-н</option><option>Джальская больница</option>
              <option>ж/м Ала-Арча 2</option><option>Завод Кока-Кола</option><option>Ипподром</option>
              <option>Калыка Акиева – Льва Толстого</option><option>Киргизия 1 ж/м</option><option>Киргизия-2 м-н</option>
              <option>Кызыл-Аскер ж/м</option><option>Лущихина – Льва Толстого</option><option>Молодая Гвардия</option>
              <option>Московская – Белинка</option><option>Московская – Уметалиева</option><option>Орок ж/м</option>
              <option>Ошский рынок</option><option>Пишпек ж/м</option><option>Рабочий Городок</option>
              <option>с. Верхний Орок</option><option>с. Джал</option><option>с. Калтар</option><option>с. Кашка-Баш</option>
              <option>с. Нижний Орок</option><option>с. Новопавловка</option><option>с. Орто-Сай</option><option>с. Сарбан</option>
              <option>с. Селекционное</option><option>с. Чон-Арык</option><option>Сейил, жилой комплекс</option>
              <option>СК. Тоо-Жели</option><option>Средний Джал м-н</option><option>Старый аэропорт</option>
              <option>Тенир-Тоо м-н</option><option>Филармония</option><option>Шлагбаум</option><option>Ынтымак ж/м</option>
            </optgroup>

            <optgroup label="Октябрьский район">
              <option>10 м-н</option><option>11 м-н</option><option>12 м-н</option><option>3 м-н</option><option>4 м-н</option>
              <option>5 м-н</option><option>6 м-н</option><option>7 м-н</option><option>8 м-н</option><option>9 м-н</option>
              <option>Айкол (с. Кок-Джар)</option><option>Ала-Арча 3</option><option>Ала-Арча ж/м</option>
              <option>Алматинка – Магистраль</option><option>Алтын-Ордо ж/м</option><option>Анар-Бак ж/м</option>
              <option>Асанбай м-н</option><option>АУЦА</option><option>Ахунбаева – Достоевского</option>
              <option>АЮ Grand</option><option>Восточная Промзона</option><option>Ген прокуратура</option>
              <option>Горького – Алма-Атинская</option><option>Жилгородок Ницца</option><option>Жилгородок Совмина ж/м</option>
              <option>Карла Маркса</option><option>КГУСТА</option><option>Кок-Жар ж/м</option><option>Кок-Жар м-н</option>
              <option>Кулатова – Матросова</option><option>Магистраль</option><option>Матросова</option><option>Мед. академия</option>
              <option>Ортосайский рынок</option><option>Парк Ататюрк</option><option>Полицейский городок м-н</option>
              <option>Проспект Айтматова</option><option>Рухий Мурас ж/м</option><option>с. Кок-Джар</option>
              <option>Советская – Скрябина</option><option>Таш Рабат</option><option>Токольдош ж/м</option><option>Тунгуч 44</option>
              <option>Тунгуч м-н</option><option>Улан м-н</option><option>Улан-2 м-н</option><option>Учкун-2 ж/м</option>
              <option>Физкультурный</option><option>Чокана Валиханова – Исакеева</option>
            </optgroup>

            <optgroup label="Первомайский район">
              <option>1000 мелочей</option><option>110 квартал ж/м</option><option>VEFA</option><option>Ак Эмир рынок</option>
              <option>Ак-Босого ж/м</option><option>Алтын-Бешик ж/м</option><option>Алтын-Казык ж/м</option><option>Аска-Таш ж/м</option>
              <option>Ата Журт</option><option>Бишкек-Парк</option><option>Боталиева – Тулебердиева</option><option>Вечерка</option>
              <option>Военторг</option><option>Восточный автовокзал</option><option>Горького – Панфилова</option><option>Дворец спорта</option>
              <option>Ден Сяопина – Фучика</option><option>Достук</option><option>Достук м-н</option><option>Душанбинка</option>
              <option>ж/м Учкун-2 (Аэропорт)</option><option>ЖД вокзал</option><option>Западный автовокзал</option>
              <option>Золотой квадрат</option><option>Калыс-Ордо 2</option><option>Калыс-Ордо ж/м</option><option>Касым ж/м</option>
              <option>Керемет ж/м</option><option>КНУ</option><option>Колмо ж/м</option><option>Космос</option><option>Кудайберген</option>
              <option>Маданият ж/м</option><option>Манаса-Кудрука</option><option>Махатма Ганди – БЧК</option><option>Моссовет</option>
              <option>Мурас-Ордо ж/м</option><option>Парк Панфилова/Спартак</option><option>Площадь Победы</option><option>Политех</option>
              <option>с. Дача СУ</option><option>с. Достук</option><option>с. Кернивоз</option><option>с. Лесное</option>
              <option>с. Маевка</option><option>с. Озёрное</option><option>с. Пригородное</option><option>с. Степное</option>
              <option>с. Учкун</option><option>Салам-Алик ж/м</option><option>Сквер Тоголок Молдо</option><option>Тендик ж/м</option>
              <option>Тоголок Молдо – Щербакова</option><option>Тоголок-Молдо – БЧК</option><option>Тынчтык м-н</option>
              <option>Умут ж/м</option><option>Щербакова ж/м</option><option>Юг-2 м-н</option>
            </optgroup>

            <optgroup label="Свердловский район">
              <option>Айкол (с. Лебединовка)</option><option>Ак-Бата ж/м</option><option>Ак-Жар ж/м</option>
              <option>Ак-Тилек 2 ж/м</option><option>Ак-Тилек ж/м</option><option>Академия МВД</option><option>Аламедин-1 м-н</option>
              <option>Аламединский рынок</option><option>Бакай-Ата ж/м</option><option>Восток-5 м-н</option>
              <option>Восточный автовокзал</option><option>Гоин</option><option>Городок строителей</option><option>Городок энергетиков</option>
              <option>Дзержинского – Куренкеева</option><option>Дордой 2 ж/м</option><option>Дордой ж/м</option><option>Дордой Плаза</option>
              <option>ж/м Биримдик Кут</option><option>Жибек-Жолу – Лермонтова</option><option>Кайынды ж/м</option>
              <option>Карагачевая роща</option><option>Карпинка</option><option>Келечек ж/м</option><option>Керамическая ж/м</option>
              <option>Керченский ж/м</option><option>Кожзавод</option><option>Комфорт</option><option>Красный Строитель 2 ж/м</option>
              <option>Красный Строитель ж/м</option><option>Лебединовка</option><option>Мадина</option><option>Нижний Токольдош</option>
              <option>Орозбекова – Жибек-Жолу</option><option>с. Аламудун</option><option>с. Восток</option><option>с. Мыкан</option>
              <option>с. Нижняя Ала-Арча</option><option>с. Садовое</option><option>Советская – БЧК</option><option>Советская – Куренкеева</option>
              <option>Советская – Щербакова</option><option>Станционный</option><option>Старый толчок</option><option>Таатан</option>
              <option>Табачка</option><option>Тоголок молдо – Куренкеева</option><option>Туберкулезная больница</option><option>ТЭЦ</option>
              <option>Учкун ж/м</option><option>Учкун м-н</option><option>Центральная мечеть</option><option>Церковь</option>
              <option>Цирк/Дворец бракосочетания</option><option>ЦУМ</option><option>Чалбай ж/м</option><option>Чуй – Алматинка</option>
              <option>Элебесова – Фере (Турбаза)</option><option>Эне-Сай ж/м</option><option>Юбилейка</option>
            </optgroup>
          </select>

          <input id="pMin" type="number" placeholder="Цена от" class="px-3 py-2 rounded-xl border border-neutral-200">
          <input id="pMax" type="number" placeholder="Цена до" class="px-3 py-2 rounded-xl border border-neutral-200">
        </div>

        <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="own"> от владельца</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="daily"> посуточно</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="long"> долгосрочно</label>
        </div>

        <div class="mt-3 flex items-center gap-6 text-sm text-neutral-600">
          <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> Анти-агент фильтр</div>
          <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-600"></span> Пуш-уведомления</div>
        </div>

        <div class="mt-auto pt-4 flex gap-3">
          <button id="btnApplyFiltersTop" class="px-4 py-2 rounded-xl bg-neutral-900 text-white hover:bg-neutral-800">Показать объявления</button>
          <button id="btnResetTop" class="px-4 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50">Сбросить</button>
        </div>
      </div>

      <div class="bg-white border border-neutral-200 rounded-2xl shadow-soft p-4 sm:p-5 h-full flex flex-col">
        <h3 class="text-xl md:text-2xl font-semibold text-blue-600 text-center mb-3">Лучший вариант на данную минуту — успей купить!!!</h3>

        <div class="rounded-xl overflow-hidden border border-neutral-200">
          <div class="aspect-[16/9] bg-neutral-100 grid place-items-center relative">
            <img id="bestImg" src="" alt="Лучшее объявление" class="w-full h-full object-cover">
            <div id="bestNoPhoto" class="hidden absolute inset-0 bg-neutral-100 grid place-items-center text-neutral-500 text-sm select-none">Нет фото</div>
          </div>

          <div class="p-3 flex items-center justify-center">
            <button id="bestCallBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 text-sm">
              Позвонить · <span id="bestMasked">+996 ••• •• •••</span>
            </button>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 px-3 pb-3">
            <div class="p-3 rounded-xl bg-neutral-50 border border-neutral-200"><div class="font-semibold" id="bestTitle"></div><div class="text-neutral-600" id="bestPrice"></div></div>
            <div class="p-3 rounded-xl bg-neutral-50 border border-neutral-200"><div class="font-semibold" id="bestDistrict"></div><div class="text-neutral-600" id="bestRooms"></div></div>
            <div class="p-3 rounded-xl bg-neutral-50 border border-neutral-200"><div class="font-semibold">Без посредников</div><div class="text-neutral-600">от владельца</div></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="container mx-auto px-4">
    <div id="ad-mid" class="my-6 rounded-2xl border border-neutral-200 bg-white shadow-soft grid place-items-center min-h-[84px] sm:min-h-[100px] md:min-h-[100px]">
      <span class="text-sm text-neutral-500">Место для рекламы (банк · мебель · интернет)</span>
    </div>
  </div>

  <main id="listings" class="container mx-auto px-4 py-1">
    <div id="listGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
    <div id="emptyState" class="hidden text-center py-16 text-neutral-600">По этим фильтрам нет свежих объявлений.</div>
  </main>

  <section class="container mx-auto px-4 pb-10">
    <h2 class="text-2xl font-bold mb-2">Тарифы доступа</h2>
    <p class="text-neutral-700 mb-6">Наши объявления живут всего 24 часа. Лучшие варианты улетают за часы. Открой номера владельцев и забронируй первым — без агентов и переплат.</p>

    <div class="grid sm:grid-cols-2 gap-4">
      <div class="rounded-2xl border border-neutral-200 bg-white p-5 shadow-soft">
        <div class="text-xl font-bold mb-1">200 сом — Неделя</div>
        <ul class="space-y-1 text-neutral-700 text-sm mb-4">
          <li>• Телефоны владельцев без лимита</li>
          <li>• Анти-агент фильтр — скрываем посредников</li>
          <li>• Пуш-уведомления о новых совпадениях</li>
          <li>• Ежесекундное обновление из 30 источников</li>
        </ul>
        <button class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 pay">Открыть номера владельцев</button>
        <div class="text-xs text-neutral-500 mt-2">Если доступ не открылся сразу — быстро решим в чате или продлим время.</div>
      </div>

      <div class="rounded-2xl border border-neutral-200 bg-white p-5 shadow-soft">
        <div class="text-xl font-bold mb-1">500 сом — Месяц</div>
        <ul class="space-y-1 text-neutral-700 text-sm mb-4">
          <li>• Телефоны владельцев без лимита</li>
          <li>• Анти-агент фильтр — скрываем посредников</li>
          <li>• Пуш-уведомления о новых совпадениях</li>
          <li>• Ежесекундное обновление из 30 источников</li>
        </ul>
        <button class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 pay">Открыть номера владельцев</button>
        <div class="text-xs text-neutral-500 mt-2">Если доступ не открылся сразу — быстро решим в чате или продлим время.</div>
      </div>
    </div>

    <details class="mt-6 rounded-2xl border border-neutral-200 bg-white p-5 shadow-soft">
      <summary class="cursor-pointer font-semibold">Частые вопросы</summary>
      <div class="mt-3 text-sm text-neutral-700 space-y-2">
        <p><b>Почему платно?</b> Мы парсим 30+ источников, фильтруем агентов и держим сервера. Плата покрывает сбор и ускоряет вам поиск.</p>
        <p><b>Можно сначала попробовать?</b> Следим за качеством: если что-то не работает, продлим доступ.</p>
        <p><b>Списаний не будет?</b> Нет автоплатежей — контролируете сами.</p>
        <p>Каждую минуту появляется что-то новое, а старое пропадает. Проверенные источники + ручная модерация жалоб. Безопасная оплата. Чеки и поддержка в Telegram.</p>
      </div>
    </details>
  </section>

  <section id="contact" class="container mx-auto px-4 pb-10">
    <h2 class="text-2xl font-bold mb-3">Связаться с нами</h2>
    <p class="text-neutral-700 mb-4 text-sm">Задайте вопрос — ответим на почту в течение дня.</p>

    <form id="contactForm" class="bg-white border border-neutral-200 rounded-2xl shadow-soft p-5 grid gap-3 max-w-2xl">
      <div class="grid sm:grid-cols-2 gap-3">
        <input type="text" name="name" placeholder="Ваше имя" required class="px-3 py-2 rounded-xl border border-neutral-200">
        <input type="email" name="email" placeholder="Ваш email" required class="px-3 py-2 rounded-xl border border-neutral-200">
      </div>
      <input type="text" name="website" style="display:none">
      <input type="hidden" name="ts" id="tsField">
      <textarea name="message" rows="5" placeholder="Сообщение" required class="px-3 py-2 rounded-xl border border-neutral-200"></textarea>
      <button type="submit" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Отправить</button>
      <div id="contactNote" class="text-xs text-neutral-500"></div>
    </form>
  </section>

  <footer class="border-t border-neutral-100 bg-white">
    <div class="container mx-auto px-4 py-8 grid md:grid-cols-4 gap-6 text-sm">
      <div class="md:col-span-2">
        <div class="flex items-center gap-2">
          <img src="./images/Arendatorkg.png" alt="Arendator.kg" class="w-7 h-7 rounded-full object-contain">
          <span class="font-semibold">Arendator.kg</span>
        </div>
        <p class="text-neutral-600 mt-2 max-w-[60ch]">Автоматически мониторим только свежие объявления от владельцев и проверенных источников, чтобы вы нашли жильё быстрее и без посредников.</p>
      </div>
      <div>
        <div class="font-semibold">Навигация</div>
        <ul class="mt-2 space-y-1 text-neutral-600">
          <li><a href="post.html" class="hover:text-blue-600">Добавить объявление</a></li>
          <li><a href="#sell" class="hover:text-blue-600">Продажа</a></li>
          <li><a href="blog.html" class="hover:text-blue-600">Блог</a></li>
        </ul>
      </div>
      <div>
        <div class="font-semibold">Правовое</div>
        <ul class="mt-2 space-y-1 text-neutral-600">
          <li><a class="hover:text-blue-600" href="#">Пользовательское соглашение</a></li>
          <li><a class="hover:text-blue-600" href="#">Политика конфиденциальности</a></li>
        </ul>
      </div>
    </div>
    <div class="text-center text-xs text-neutral-500 pb-6">© 2025 — Arendator.kg</div>
  </footer>

  <!-- Модалки -->
  <div id="modalLogin" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-soft">
      <div class="text-lg font-semibold">Вход без пароля</div>
      <p class="text-sm text-neutral-600 mt-1">Войдите по номеру — отправим код в SMS.<br>Или через Telegram одним нажатием.</p>
      <input id="loginPhone" placeholder="0(555) 123-456" class="mt-4 w-full px-3 py-2 rounded-xl border border-neutral-200" />
      <div class="mt-3 grid grid-cols-2 gap-2">
        <button id="btnSendCode" class="px-4 py-2 rounded-xl bg-neutral-900 text-white">Отправить код</button>
        <button id="btnCloseLogin" class="px-4 py-2 rounded-xl border border-neutral-200">Закрыть</button>
      </div>
      <div id="loginStep2" class="hidden mt-4">
        <input id="loginOtp" placeholder="Код из SMS" class="w-full px-3 py-2 rounded-xl border border-neutral-200" />
        <button id="btnConfirmOtp" class="mt-3 w-full px-4 py-2 rounded-xl bg-blue-600 text-white">Войти</button>
      </div>
      <div class="my-4 flex items-center gap-3">
        <div class="h-px flex-1 bg-neutral-200"></div>
        <div class="text-xs text-neutral-500">или Telegram</div>
        <div class="h-пx flex-1 bg-neutral-200"></div>
      </div>
      <div id="tgLoginContainer" class="flex justify-center"></div>
      <div class="text-xs text-neutral-500 text-center mt-2">После нажатия появится окно Telegram — откройте Telegram и нажмите «Принять / Allow», чтобы завершить вход.</div>

      <!-- Доп. способы -->
      <div class="mt-3 text-xs text-neutral-500 text-center">или:</div>
      <div class="mt-2 grid grid-cols-2 gap-2">
        <button id="btnLoginWhatsApp" class="px-3 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50">Войти через WhatsApp</button>
        <button id="btnLoginEmail" class="px-3 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50">Войти по e-mail</button>
      </div>
      <div id="loginEmailBlock" class="hidden mt-3 space-y-2">
        <input id="loginEmail" type="email" placeholder="you@email.com" class="w-full px-3 py-2 rounded-xl border border-neutral-200">
        <button id="btnSendEmailLink" class="w-full px-4 py-2 rounded-xl bg-neutral-900 text-white">Отправить ссылку для входа</button>
        <div class="text-xs text-neutral-500">Мы пришлём «магическую» ссылку на почту.</div>
      </div>
    </div>
  </div>

  <div id="modalProfile" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-soft">
      <div class="text-lg font-semibold">Мой профиль</div>
      <p class="text-sm text-neutral-600 mt-1">Измени аватарку. (Пока локально, без сервера)</p>
      <div class="mt-4">
        <div id="profileAvatar" class="avatar-lg">U</div>
        <div class="mt-4 grid grid-cols-2 gap-2">
          <label class="px-4 py-2 rounded-xl bg-neutral-900 text-white text-center cursor-pointer">
            <input id="avatarFile" type="file" accept="image/*" class="hidden">Загрузить
          </label>
          <button id="btnAvatarRemove" class="px-4 py-2 rounded-xl border border-neutral-200">Удалить</button>
        </div>
      </div>
      <div class="mt-6 grid grid-cols-2 gap-2">
        <button id="btnCloseProfile" class="px-4 py-2 rounded-xl border border-neutral-200">Закрыть</button>
        <button id="btnSaveProfile" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Сохранить</button>
      </div>
    </div>
  </div>

  <div id="modalEditProfile" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-soft">
      <div class="text-lg font-semibold">Редактировать профиль</div>
      <div class="mt-4 space-y-3">
        <input id="profName" type="text" placeholder="Моё имя" class="w-full px-3 py-2 rounded-xl border border-neutral-200">
        <input id="profEmail" type="email" placeholder="E-mail" class="w-full px-3 py-2 rounded-xl border border-neutral-200">
        <input id="profPhone" type="tel" placeholder="Телефон" class="w-full px-3 py-2 rounded-xl border border-neutral-200">
        <textarea id="profAbout" rows="4" placeholder="Обо мне" class="w-full px-3 py-2 rounded-xl border border-neutral-200"></textarea>
      </div>
      <div class="mt-6 grid grid-cols-2 gap-2">
        <button id="btnCloseEditProfile" class="px-4 py-2 rounded-xl border border-neutral-200">Отмена</button>
        <button id="btnSaveEditProfile" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Сохранить</button>
      </div>
    </div>
  </div>

  <div id="modalPay" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-soft">
      <div class="text-lg font-semibold">Открой номера владельцев</div>
      <p class="text-sm text-neutral-600 mt-1">После оплаты доступ активируется автоматически. Никаких автопродлений.</p>
      <div class="mt-4 grid grid-cols-3 gap-2 text-sm">
        <button class="pay-method px-3 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50" data-method="mbank">MBank QR</button>
        <button class="pay-method px-3 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50" data-method="elqr">ELQR</button>
        <button class="pay-method px-3 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50" data-method="card">Карта</button>
      </div>
      <div id="paySelected" class="mt-4 text-sm text-neutral-700 hidden">Вы выбрали: <span class="font-medium" id="payMethodName"></span></div>
      <div class="mt-4 grid grid-cols-2 gap-2">
        <button id="btnSimulatePaid" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Оплата прошла (демо)</button>
        <button id="btnClosePay" class="px-4 py-2 rounded-xl border border-neutral-200">Отмена</button>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-xl bg-neutral-900 text-white text-sm"></div>

  <script>
    /* ======= ДЕМО-данные и утилиты ======= */
    const listings = [
      { id:'l1', title:'2к, Центр, свежий ремонт', price:35000, district:'Центр', rooms:'2', daily:false, owner:true, img:'', phone:'+996555123456', expiresAt: Date.now()+23*3600e3+30*60e3 },
      { id:'l2', title:'1к, Майевка, уютная',      price:18000, district:'Майевка', rooms:'1', daily:false, owner:true, img:'https://images.unsplash.com/photo-1502005229762-cf1b2da7cda7?q=80&w=1200&auto=format&fit=crop', phone:'+996700222333', expiresAt: Date.now()+10*3600e3 },
      { id:'l3', title:'3к, Асанбай, вид на горы', price:55000, district:'Асанбай', rooms:'3+',daily:false, owner:false,img:'https://images.unsplash.com/photo-1560066984-138dadb4c035?q=80&w=1200&auto=format&fit=crop', phone:'+996777444555', expiresAt: Date.now()+6*3600e3 },
      { id:'l4', title:'Студия, Московский',       price:22000, district:'Московский',rooms:'1', daily:false, owner:true, img:'https://images.unsplash.com/photo-1493809842364-78817add7ffb?q=80&w=1200&auto=format&fit=crop', phone:'+996555987654', expiresAt: Date.now()+12*3600e3 },
      { id:'l5', title:'Посуточно 2к, Центр',      price:3000,  district:'Центр', rooms:'2', daily:true,  owner:true, img:'https://images.unsplash.com/photo-1502823403499-6ccfcf4fb453?q=80&w=1200&auto=format&fit=crop', phone:'+996709111222', expiresAt: Date.now()+20*3600e3 },
      { id:'l6', title:'3к, Свердловский, новая мебель', price:45000, district:'Свердловский', rooms:'3+', daily:false, owner:true, img:'https://images.unsplash.com/photo-1494526585095-c41746248156?q=80&w=1200&auto=format&fit=crop', phone:'+996500321654', expiresAt: Date.now()+5*3600e3 },
    ];

    const qs  = (s,el=document)=>el.querySelector(s);
    const qsa = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const showToast=(m)=>{const t=qs('#toast');t.textContent=m;t.classList.remove('hidden');clearTimeout(showToast.t);showToast.t=setTimeout(()=>t.classList.add('hidden'),2200);};
    const hasAccess=()=>Date.now() < Number(localStorage.getItem('accessUntil')||0);
    const maskPhone=(p)=> p ? p.replace(/(\+\d{3})\d+/, '$1 ••• •• •••') : '•••';

    /* ========= СИНХРОНИЗАЦИЯ АККАУНТА МЕЖДУ ТЕЛЕФОНОМ И ПК =========
       Работает через серверные эндпоинты (cookie auth):
       GET  /api/user-state -> {ok:true, state:{ profile, avatar_url, favs, accessUntil }}
       POST /api/user-state -> {ok:true}
       Если сервер их ещё не реализовал — всё продолжит работать локально.
    ================================================================= */
    const SYNC_ENDPOINT = '/api/user-state';
    let loadingServerState = false;
    let saveTimer = null;

    function collectState(){
      let profile = {}; try { profile = JSON.parse(localStorage.getItem('profile')||'{}'); } catch(_){}
      const avatar_url = localStorage.getItem('avatar_url') || '';
      let favs = [];   try { favs = JSON.parse(localStorage.getItem('favs')||'[]'); } catch(_){}
      const accessUntil = localStorage.getItem('accessUntil') || '';
      return { profile, avatar_url, favs, accessUntil };
    }
    function statesEqual(a,b){ try{ return JSON.stringify(a||{})===JSON.stringify(b||{});}catch(_){return false;} }

    async function loadServerState(){
      try{
        const r = await fetch(SYNC_ENDPOINT, { credentials:'include' });
        if (!r.ok) return;
        const d = await r.json();
        if (!d || !d.ok || !d.state) return;
        const incoming = d.state;
        const local = collectState();
        if (statesEqual(local, incoming)) return;

        loadingServerState = true;
        if ('profile' in incoming)      (incoming.profile ? localStorage.setItem('profile', JSON.stringify(incoming.profile)) : localStorage.removeItem('profile'));
        if ('avatar_url' in incoming)   (incoming.avatar_url ? localStorage.setItem('avatar_url', incoming.avatar_url) : localStorage.removeItem('avatar_url'));
        if ('favs' in incoming)         (incoming.favs ? localStorage.setItem('favs', JSON.stringify(incoming.favs)) : localStorage.removeItem('favs'));
        if ('accessUntil' in incoming)  (incoming.accessUntil ? localStorage.setItem('accessUntil', incoming.accessUntil) : localStorage.removeItem('accessUntil'));
        updateAuthUI(); render();
        setTimeout(()=>{ loadingServerState=false; }, 200);
      }catch(_){ /* молча уходим в оффлайн-режим */ }
    }

    async function saveServerState(){
      try{
        const state = collectState();
        await fetch(SYNC_ENDPOINT, {
          method:'POST', credentials:'include',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ state })
        });
      }catch(_){ /* если сервера нет — просто пропускаем */ }
    }
    function saveServerStateDebounced(){
      if (loadingServerState) return;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveServerState, 600);
    }

    /* ---------- СЕССИЯ: универсальная проверка ---------- */
    let loginPoll = null;
    async function checkSession(silent=true){
      try{
        const r = await fetch('/api/me', { credentials:'include' });
        const data = await r.json();
        if (data && data.ok){
          try{ localStorage.setItem('userLogged','1'); }catch(_){}
          try{ localStorage.setItem('tg_user', JSON.stringify(data.user||{})); }catch(_){}
          try{ closeLogin(); }catch(_){}
          ensureUserScoped();     // важная вставка: предотвращает «другой аккаунт» на этом же устройстве
          updateAuthUI();
          if (!silent) showToast('Вход выполнен');
          return true;
        }
      }catch(_){}
      return false;
    }

    /* ======= Лучший блок / карточки / избранное ======= */
    let bestItem=null;
    function renderBest(){
      bestItem = listings.find(it=>!it.daily && it.price<=25000) || listings[0];
      const imgEl=qs('#bestImg'), noPhoto=qs('#bestNoPhoto'), btn=qs('#bestCallBtn'), masked=qs('#bestMasked');
      if (bestItem.img){ imgEl.src=bestItem.img; imgEl.alt=bestItem.title||'Лучшее объявление'; imgEl.classList.remove('hidden'); noPhoto.classList.add('hidden'); }
      else { imgEl.removeAttribute('src'); imgEl.classList.add('hidden'); noPhoto.classList.remove('hidden'); }
      masked.textContent = maskPhone(bestItem.phone||'');
      qs('#bestTitle').textContent = bestItem.title||'';
      qs('#bestPrice').textContent = (bestItem.price||0).toLocaleString('ru-RU')+' сом';
      qs('#bestDistrict').textContent = bestItem.district||'';
      qs('#bestRooms').textContent   = 'Комнат: '+(bestItem.rooms||'');
      btn.onclick = () => {
        if(!localStorage.getItem('userLogged')){ openLogin(); return; }
        if(!hasAccess()){ openPay(); return; }
        if(bestItem?.phone){ location.href = `tel:${bestItem.phone}`; }
      };
    }

    function cardHTML(it){
      const priceUnit = it.daily ? 'сом/сут' : 'сом/мес';
      const favs = new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
      const isFav = favs.has(it.id);
      return `
      <article class="rounded-2xl border border-neutral-200 bg-white overflow-hidden shadow-sm hover:shadow-md transition-shadow flex flex-col h-full">
        <div class="aspect-[4/3] overflow-hidden grid place-items-center bg-neutral-100">
          ${it.img ? `<img src="${it.img}" alt="${it.title}" class="w-full h-full object-cover">` : `<div class="text-neutral-500 text-sm">Нет фото</div>`}
        </div>
        <div class="p-4 flex-1 flex flex-col gap-3">
          <div class="flex items-start gap-2">
            <h3 class="font-semibold leading-snug">${it.title}</h3>
            <span class="ml-auto inline-flex items-center text-xs px-2 py-1 rounded-full whitespace-nowrap ${it.owner?'bg-emerald-100 text-emerald-700':'bg-neutral-100 text-neutral-700'}">${it.owner?'Без посредников':'Источник'}</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="text-2xl font-bold">${it.price.toLocaleString('ru-RU')} <span class="text-sm font-medium text-neutral-500">${priceUnit}</span></div>
            <div class="ml-auto text-xs text-neutral-600">осталось <span class="countdown" data-ts="${it.expiresAt}"></span></div>
          </div>
          <div class="flex items-center gap-2 text-sm text-neutral-600"><div>${it.district}</div><div>·</div><div>Комнат: ${it.rooms}</div></div>
          <div class="mt-auto card-actions">
            <input readonly class="flex-1 px-3 py-2 rounded-xl border border-neutral-200 bg-neutral-50 ${hasAccess()?'':'mask-blur'}" value="${it.phone}">
            <button class="px-3 py-2 rounded-xl bg-blue-600 text-white text-sm reveal-btn" data-id="${it.id}">${hasAccess()?'Скопировать':'Показать номер'}</button>
          </div>
          <div class="flex items-center justify-between text-xs text-neutral-500 pt-1">
            <span></span>
            <button class="fav-btn hover:text-blue-600 inline-flex items-center gap-1" data-id="${it.id}" title="В избранное">
              <span class="heart ${isFav?'text-red-600':''}">${isFav?'❤':'♡'}</span> В избранное
            </button>
          </div>
        </div>
      </article>`;
    }

    function renderListings(data){
      const grid=qs('#listGrid'); grid.innerHTML='';
      if(!data.length){ qs('#emptyState').classList.remove('hidden'); return; }
      qs('#emptyState').classList.add('hidden');
      data.forEach(it=> grid.insertAdjacentHTML('beforeend', cardHTML(it)));
      qsa('.countdown').forEach(el=>countdown(el, Number(el.dataset.ts)));
      qsa('.reveal-btn').forEach(btn=>btn.addEventListener('click', onRevealClick));
      qsa('.fav-btn').forEach(btn=>btn.addEventListener('click', onFavClick));
    }

    function onRevealClick(e){
      const btn=e.currentTarget;
      if(!localStorage.getItem('userLogged')){ openLogin(); return; }
      if(!hasAccess()){ openPay(); return; }
      const input=btn.closest('article').querySelector('input');
      navigator.clipboard.writeText(input.value).then(()=>showToast('Номер скопирован'));
    }

    function onFavClick(e){
      if(!localStorage.getItem('userLogged')){ openLogin(); return; }
      const id=e.currentTarget.dataset.id;
      const favs=new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
      const heart=e.currentTarget.querySelector('.heart');
      if(favs.has(id)){ favs.delete(id); heart.textContent='♡'; heart.classList.remove('text-red-600'); showToast('Убрано из избранного'); }
      else{ favs.add(id); heart.textContent='❤'; heart.classList.add('text-red-600'); showToast('Добавлено в избранное'); }
      localStorage.setItem('favs', JSON.stringify([...favs]));
      saveServerStateDebounced(); // СИНХ
    }

    /* ======= Модалки ======= */
    const modalLogin=qs('#modalLogin'), modalPay=qs('#modalPay'), modalProfile=qs('#modalProfile'), modalEdit=qs('#modalEditProfile');
    const openLogin =()=>{ modalLogin.classList.remove('hidden'); modalLogin.classList.add('flex');
      // Лениво вставляем виджет + запускаем короткий поллинг на 10 сек
      mountTelegramWidget();
      if (loginPoll) clearInterval(loginPoll);
      let ticks=0; loginPoll=setInterval(async ()=>{ ticks++; const ok=await checkSession(true); if(ok||ticks>10){ clearInterval(loginPoll); loginPoll=null; } },1000);
    };
    const closeLogin=()=>{ modalLogin.classList.add('hidden'); modalLogin.classList.remove('flex'); if (loginPoll) { clearInterval(loginPoll); loginPoll=null; } };
    const openPay   =()=>{ modalPay.classList.remove('hidden'); modalPay.classList.add('flex'); }
    const closePay  =()=>{ modalPay.classList.add('hidden'); modalPay.classList.remove('flex'); }
    const openProfile=()=>{ modalProfile.classList.remove('hidden'); modalProfile.classList.add('flex'); syncProfileModal(); }
    const closeProfile=()=>{ modalProfile.classList.add('hidden'); modalProfile.classList.remove('flex'); }
    const openEdit=()=>{ fillEditProfileModal(); modalEdit.classList.remove('hidden'); modalEdit.classList.add('flex'); }
    const closeEdit=()=>{ modalEdit.classList.add('hidden'); modalEdit.classList.remove('flex'); }

    /* ======= Telegram Login — лениво монтируем виджет ======= */
    function mountTelegramWidget(){
      if (qs('#tgLoginContainer script')) return;
      const s=document.createElement('script');
      s.src='https://telegram.org/js/telegram-widget.js?22';
      s.async=true;
      s.setAttribute('data-telegram-login','ArendatorKGbot');
      s.setAttribute('data-size','large');
      s.setAttribute('data-userpic','false');
      s.setAttribute('data-request-access','write');
      const CANON = 'https://arendator.kg';
      const back  = encodeURIComponent((location.pathname+location.search) || '/');
      s.setAttribute('data-auth-url', `${CANON}/api/tg-login?return_to=${back}`);
      qs('#tgLoginContainer').appendChild(s);
    }

    /* ======= Ответ из окна авторизации (postMessage) ======= */
    window.addEventListener('message', async (ev) => {
      const msg = ev.data || {};
      if (msg && msg.type === 'tg-auth') {
        if (msg.ok) {
          try{ localStorage.setItem('userLogged','1'); }catch(_){}
          try{ localStorage.setItem('tg_user', JSON.stringify(msg.user||{})); }catch(_){}
          await checkSession(true);
          ensureUserScoped();
          await loadServerState();   // подхватить серверное состояние сразу после логина
          updateAuthUI(); closeLogin(); showToast('Вход через Telegram выполнен');
        } else {
          showToast('Не удалось войти через Telegram');
        }
      }
    }, false);

    /* ======= Cookie → localStorage и быстрое обновление UI ======= */
    const hasAuthCookie=()=> document.cookie.split("; ").some(c => c.trim().startsWith("auth="));
    function syncAuthFromCookieAndQuery(){
      const p = new URLSearchParams(location.search);
      if (p.get("tg") === "ok" || hasAuthCookie()) {
        try { localStorage.setItem("userLogged","1"); } catch(_){}
        if (p.get("tg") === "ok") history.replaceState(null,"",location.pathname);
      }
    }

    /* ======= Язык ======= */
    function setLangUI(lang){
      qsa('#langToggle .ru, #langToggleMobile .ru').forEach(el=>el.classList.toggle('active', lang==='ru'));
      qsa('#langToggle .ky, #langToggleMobile .ky').forEach(el=>el.classList.toggle('active', lang==='ky'));
    }
    function initLang(){
      const lang = localStorage.getItem('lang') || 'ru';
      setLangUI(lang);
      const bind = id => {
        const el = qs(id); if(!el) return;
        el.addEventListener('click', ()=>{
          const cur = localStorage.getItem('lang') || 'ru';
          const next = cur==='ru' ? 'ky' : 'ru';
          localStorage.setItem('lang', next); setLangUI(next);
        });
      };
      bind('#langToggle'); bind('#langToggleMobile');
    }

    /* ======= Привязка локального состояния к конкретному юзеру (важно при смене аккаунта) ======= */
    function ensureUserScoped(){
      let u={}; try{ u = JSON.parse(localStorage.getItem('tg_user')||'{}'); }catch(_){}
      const uid = u.id || u.user_id || u.telegram_id || u._id || null;
      const prev = localStorage.getItem('current_uid');
      if (uid && prev && prev !== String(uid)){
        // Очистить локальное состояние другого пользователя
        localStorage.removeItem('profile');
        localStorage.removeItem('avatar_url');
        localStorage.removeItem('favs');
        localStorage.removeItem('accessUntil');
      }
      if (uid) localStorage.setItem('current_uid', String(uid));
    }

    /* ======= UI аккаунта ======= */
    function updateAuthUI(){
      const logged  = !!localStorage.getItem('userLogged');
      const btn=qs('#btnAuth'), badge=qs('#userBadge'), avatar=qs('#userAvatar'), menu=qs('#accountMenu');
      const btnM=qs('#btnAuthMobile'), badgeM=qs('#userBadgeMobile'), avatarM=qs('#userAvatarMobile'), menuM=qs('#accountMenuMobile');
      if (btn) btn.textContent  = logged ? 'Мой аккаунт' : 'Вход / регистрация';
      if (btnM) btnM.textContent = logged ? 'Аккаунт' : 'Вход / регистрация';

      const applyUser = (avatarEl, badgeEl, menuEl) => {
        if (!avatarEl || !badgeEl) return;
        if (!logged){ badgeEl.classList.add('hidden'); avatarEl.style.backgroundImage=''; avatarEl.textContent=''; menuEl?.classList.add('hidden'); return; }
        let u={}; try{u=JSON.parse(localStorage.getItem('tg_user')||'{}')}catch(_){}
        const localAvatar = localStorage.getItem('avatar_url') || '';
        const initial = (u.first_name?.trim()?.[0] || u.username?.trim()?.[0] || 'U').toUpperCase();
        avatarEl.style.backgroundImage=''; avatarEl.textContent=initial;
        const imgUrl = localAvatar || u.photo_url || '';
        if (imgUrl){ avatarEl.style.backgroundImage=`url("${imgUrl}")`; avatarEl.textContent=''; }
        badgeEl.classList.remove('hidden');
      };
      applyUser(avatar, badge, menu);
      applyUser(avatarM, badgeM, menuM);
    }

    /* ======= "Снять/Купить" как селект ======= */
    (function initDealSelect(){
      const sel = qs('#dealSelect');
      if (!sel) return;
      const saved = localStorage.getItem('dealType') || 'rent';
      sel.value = saved;
      sel.addEventListener('change', ()=>{ localStorage.setItem('dealType', sel.value); });
    })();

    /* ======= (устар.) плашка табов оставлена для совместимости ======= */
    (function initDealTabs(){
      const tabs = qs('#dealTabs');
      if (!tabs) return;
      tabs.addEventListener('click', (e)=>{
        const b = e.target.closest('button[data-deal]'); if(!b) return;
        qsa('button', tabs).forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        try{ localStorage.setItem('dealType', b.dataset.deal); }catch(_){}
      });
      const saved = localStorage.getItem('dealType') || 'rent';
      qsa('button', tabs).forEach(x=> x.classList.toggle('active', x.dataset.deal===saved));
    })();

    /* ======= Показ/скрытие районов Бишкек по выбору области ======= */
    (function initRegionVisibility(){
      const region = qs('#s3');
      const districts = qs('#s4');
      if (!region || !districts) return;
      const update = () => {
        const isBishkek = (region.value||'').toLowerCase().includes('бишкек');
        districts.style.display = isBishkek ? '' : 'none';
      };
      update();
      region.addEventListener('change', update);
    })();

    /* ======= События ======= */
    qs('#btnCloseLogin').addEventListener('click', closeLogin);
    qs('#btnSendCode').addEventListener('click', ()=>{ qs('#loginStep2').classList.remove('hidden'); showToast('Код отправлен (демо)'); });
    qs('#btnConfirmOtp').addEventListener('click', async ()=>{ localStorage.setItem('userLogged','1'); await checkSession(true); ensureUserScoped(); await loadServerState(); closeLogin(); updateAuthUI(); showToast('Вход выполнен'); });

    qsa('.pay').forEach(b=>b.addEventListener('click', openPay));
    qsa('.pay-method').forEach(b=> b.addEventListener('click', ()=>{ qs('#paySelected').classList.remove('hidden'); qs('#payMethodName').textContent=b.textContent; }));
    qs('#btnClosePay').addEventListener('click', closePay);
    qs('#btnSimulatePaid').addEventListener('click', ()=>{ 
      localStorage.setItem('accessUntil', String(Date.now()+24*3600e3)); 
      showToast('Доступ открыт на 24 часа'); 
      render(); 
      saveServerStateDebounced(); // СИНХ
      closePay(); 
    });

    document.addEventListener('click', (ev) => {
      const trg = ev.target.closest('#btnAuth, #btnAuthMobile, #userAvatar, #userAvatarMobile');
      if (trg){
        const logged = !!localStorage.getItem('userLogged');
        const isMobile = !!ev.target.closest('#accountAreaMobile');
        const menu = isMobile ? qs('#accountMenuMobile') : qs('#accountMenu');
        if (logged){ menu?.classList.toggle('hidden'); }
        else { openLogin(); }
        return;
      }
      if (!ev.target.closest('#accountMenu') && !ev.target.closest('#accountArea')) qs('#accountMenu')?.classList.add('hidden');
      if (!ev.target.closest('#accountMenuMobile') && !ev.target.closest('#accountAreaMobile')) qs('#accountMenuMobile')?.classList.add('hidden');
    });

    /* ПК-меню */
    qs('#menuMyAds').addEventListener('click', ()=>{ qs('#accountMenu').classList.add('hidden'); showToast('Мои объявления (демо)'); });
    qs('#menuEditProfile').addEventListener('click', ()=>{ qs('#accountMenu').classList.add('hidden'); openEdit(); });
    qs('#menuChangeAvatar').addEventListener('click', ()=>{ qs('#accountMenu').classList.add('hidden'); openProfile(); });

    qs('#menuLogout').addEventListener('click', ()=>{
      qs('#accountMenu').classList.add('hidden');
      try{ localStorage.removeItem('userLogged'); localStorage.removeItem('tg_user'); localStorage.removeItem('current_uid'); }catch(_){}
      document.cookie = 'auth=; Max-Age=0; path=/';
      updateAuthUI(); showToast('Вы вышли из аккаунта');
    });

    /* МОБИЛЬНОЕ МЕНЮ — все кнопки полноценно работают */
    const accMenuM = qs('#accountMenuMobile');
    qs('#menuMyAdsM')?.addEventListener('click', ()=>{ accMenuM?.classList.add('hidden'); showToast('Мои объявления (демо)'); });
    qs('#menuEditProfileM')?.addEventListener('click', ()=>{ accMenuM?.classList.add('hidden'); openEdit(); });
    qs('#menuChangeAvatarM')?.addEventListener('click', ()=>{ accMenuM?.classList.add('hidden'); openProfile(); });
    qs('#menuLogoutM')?.addEventListener('click', ()=> {
      accMenuM?.classList.add('hidden');
      try{ localStorage.removeItem('userLogged'); localStorage.removeItem('tg_user'); localStorage.removeItem('current_uid'); }catch(_){}
      document.cookie = 'auth=; Max-Age=0; path=/';
      updateAuthUI(); showToast('Вы вышли из аккаунта');
    });

    function fillEditProfileModal(){
      const p = JSON.parse(localStorage.getItem('profile')||'{}');
      qs('#profName').value  = p.name  || '';
      qs('#profEmail').value = p.email || '';
      qs('#profPhone').value = p.phone || '';
      qs('#profAbout').value = p.about || '';
    }
    qs('#btnCloseEditProfile').addEventListener('click', closeEdit);
    qs('#btnSaveEditProfile').addEventListener('click', ()=>{
      const data = { name:qs('#profName').value.trim(), email:qs('#profEmail').value.trim(), phone:qs('#profPhone').value.trim(), about:qs('#profAbout').value.trim() };
      localStorage.setItem('profile', JSON.stringify(data));
      closeEdit(); updateAuthUI(); showToast('Профиль сохранён');
      saveServerStateDebounced(); // СИНХ
    });

    qs('#btnCloseProfile').addEventListener('click', closeProfile);
    qs('#btnSaveProfile').addEventListener('click', ()=>{ closeProfile(); showToast('Профиль сохранён'); updateAuthUI(); saveServerStateDebounced(); });

    qs('#avatarFile').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if (!file) return;
      try{
        const dataUrl = await fileToAvatarDataURL(file, 256);
        localStorage.setItem('avatar_url', dataUrl); syncProfileModal(); updateAuthUI(); showToast('Аватар обновлён');
        saveServerStateDebounced(); // СИНХ
      }catch{ showToast('Не удалось обработать изображение'); }
    });
    qs('#btnAvatarRemove').addEventListener('click', ()=>{ localStorage.removeItem('avatar_url'); syncProfileModal(); updateAuthUI(); showToast('Аватар удалён'); saveServerStateDebounced(); });

    function syncProfileModal(){
      const box = qs('#profileAvatar');
      let u = {}; try { u = JSON.parse(localStorage.getItem('tg_user')||'{}'); } catch(_){}
      const initial = (u.first_name?.trim()?.[0] || u.username?.trim()?.[0] || 'U').toUpperCase();
      const localAvatar = localStorage.getItem('avatar_url');
      box.style.backgroundImage = ''; box.textContent = initial;
      if (localAvatar){ box.style.backgroundImage = `url(${localAvatar})`; box.textContent = ''; }
      else if (u.photo_url){ box.style.backgroundImage = `url(${u.photo_url})`; box.textContent = ''; }
    }

    function fileToAvatarDataURL(file, size=256){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=>{
          const s = Math.min(img.width, img.height);
          const sx = (img.width - s)/2, sy = (img.height - s)/2;
          const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size;
          const ctx = canvas.getContext('2d'); ctx.drawImage(img, sx, sy, s, s, 0, 0, size, size);
          resolve(canvas.toDataURL('image/jpeg', 0.85));
        };
        img.onerror = reject;
        const reader = new FileReader();
        reader.onload = () => { img.src = reader.result; };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function applyFilters(){
      const priceMin = Number(qs('#pMin').value || 0);
      const priceMax = Number(qs('#pMax').value || Infinity);
      const onlyOwn = qs('#own').checked;
      const onlyDaily = qs('#daily').checked;
      const onlyLong = qs('#long').checked;
      let out=listings.filter(it=>(it.price>=priceMin && it.price<=priceMax && (!onlyOwn || it.owner) && (!onlyDaily || it.daily) && (!onlyLong || !it.daily)));
      out.sort((a,b)=>b.expiresAt-a.expiresAt);
      renderListings(out);
    }

    function render(){ renderBest(); applyFilters(); updateAuthUI(); }

    document.addEventListener('DOMContentLoaded', async () => {
      try { syncAuthFromCookieAndQuery(); } catch(_){}
      updateAuthUI();              // мгновенное обновление UI (фикс для мобильных)
      try { initLang(); } catch(_){}
      await checkSession(true);    // подтянуть профиль, если уже вошли
      ensureUserScoped();
      await loadServerState();     // ПОДХВАТИТЬ ОБЩЕЕ СОСТОЯНИЕ С СЕРВЕРА
      try { render(); } catch(_){}
    });

    // Доп. хуки: при возврате в вкладку подтягиваем серверное состояние (для кросс-девайса)
    window.addEventListener('focus', () => { checkSession(true).then(()=>{ updateAuthUI(); loadServerState(); }); });
    window.addEventListener('pageshow', () => { checkSession(true).then(()=>{ updateAuthUI(); loadServerState(); }); });
    document.addEventListener('visibilitychange', () => { if (!document.hidden) { checkSession(true); loadServerState(); } });

    // Периодическая мягкая синхронизация (если сервер доступен)
    setInterval(() => { checkSession(true).then(()=>{ updateAuthUI(); loadServerState(); }); }, 30000);

    window.addEventListener('storage', (e) => {
      if (['userLogged','avatar_url','tg_user','lang','profile','favs','accessUntil'].includes(e.key)) {
        try { updateAuthUI(); } catch(_){}
        if (e.key === 'lang') try { setLangUI(localStorage.getItem('lang')||'ru'); } catch(_){}
      }
    });

    // Простейший таймер обратного отсчёта
    function countdown(el, ts){
      function tick(){
        const ms = ts - Date.now();
        if (ms <= 0){ el.textContent = '0ч 00м'; return; }
        const h = Math.floor(ms/3600000);
        const m = Math.floor((ms%3600000)/60000);
        el.textContent = `${h}ч ${String(m).padStart(2,'0')}м`;
        requestAnimationFrame(tick);
      }
      tick();
    }
  </script>

  <!-- Второй скрипт: WA/e-mail + форма контакта -->
  <script>
  (() => {
    const waBtn   = document.getElementById('btnLoginWhatsApp');
    const emBtn   = document.getElementById('btnLoginEmail');
    const emBox   = document.getElementById('loginEmailBlock');
    const emInput = document.getElementById('loginEmail');
    const emSend  = document.getElementById('btnSendEmailLink');

    const WA_NUMBER = '996555123456';

    if (waBtn) {
      waBtn.addEventListener('click', () => {
        const text = encodeURIComponent('Здравствуйте! Хочу войти в Arendator.kg');
        window.open(`https://wa.me/${WA_NUMBER}?text=${text}`, '_blank');
      });
    }

    if (emBtn) {
      emBtn.addEventListener('click', () => { emBox?.classList.toggle('hidden'); });
    }

    if (emSend) {
      emSend.addEventListener('click', async () => {
        const email = (emInput?.value || '').trim();
        if (!email) { alert('Укажи e-mail'); return; }
        const magic = Math.random().toString(36).slice(2);
        try { localStorage.setItem('email_magic_' + email, magic); } catch(_){}
        const link = `${location.origin}/?login=${encodeURIComponent(email)}&magic=${magic}`;
        const html = `<p>Привет! Для входа в Arendator.kg нажми ссылку:</p><p><a href="${link}">Войти</a></p><p>Если это были не вы — просто игнорируйте письмо.</p>`;
        try {
          const res = await fetch('/api/send-mail', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ to:email, subject:'Вход в Arendator.kg', html })
          });
          const data = await res.json();
          if (data.ok) alert('Ссылка отправлена на почту.');
          else alert('Не удалось отправить: ' + (data.error || 'ошибка'));
        } catch { alert('Сеть недоступна, попробуй ещё раз.'); }
      });
    }

    // Автовход по "магической" ссылке (демо)
    (function emailMagicAutoLogin(){
      const p = new URLSearchParams(location.search);
      const email = p.get('login');
      const magic = p.get('magic');
      if (!email || !magic) return;

      try {
        const saved = localStorage.getItem('email_magic_' + email);
        if (saved && saved === magic) {
          localStorage.setItem('userLogged','1');
          history.replaceState(null,'',location.pathname);
          try { updateAuthUI(); } catch(_){}
          try { document.getElementById('modalLogin')?.classList.add('hidden'); } catch(_){}
          const t = document.getElementById('toast');
          if (t){ t.textContent='Вход по email выполнен'; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2000); }
        }
      } catch(_){}
    })();

    // Форма контакта
    const ts = document.getElementById('tsField'); if (ts) ts.value = Date.now();
    const form = document.getElementById('contactForm');
    const note = document.getElementById('contactNote');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const payload = Object.fromEntries(fd.entries());
        if (payload.website && payload.website.trim() !== '') { form.reset(); if (note) note.textContent = 'Спасибо!'; return; }
        payload.to = 'reply@arendator.kg';
        try {
          const res = await fetch('/api/send-mail', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const data = await res.json();
          if (data.ok) { form.reset(); if (note) note.textContent = 'Сообщение отправлено.'; if (ts) ts.value = Date.now(); }
          else { if (note) note.textContent = 'Ошибка: ' + (data.error || 'не удалось отправить'); }
        } catch { if (note) note.textContent = 'Ошибка сети. Попробуйте ещё раз.'; }
      });
    }
  })();
  </script>

  <!-- Если у тебя есть собственный app.js — оставляй -->
  <script src="/app.js"></script>
</body>
</html>
