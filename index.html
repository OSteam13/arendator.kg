<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arendator.kg — свежие квартиры без посредников</title>
  <meta name="description" content="Свежие объявления аренды от владельцев. Анти‑агент фильтр. Доступ к телефонам по подписке. Объявления живут 24 часа." />
  <link rel="icon" href="./images/Arendatorkg.png">
  <!-- Onest: 400 (Regular) + 800 (ExtraBold) -->
  <link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--container:1180px; --ads:110px}
    .container{max-width:var(--container)}
    .shadow-soft{box-shadow:0 8px 30px rgba(0,0,0,.08)}
    html,body{overflow-x:hidden;font-family:'Onest',system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;font-weight:400}
    .hero-title{font-weight:800}

    /* header above all */
    header .container > * { position: relative; z-index: 10; }

    .side-ads{position:fixed;top:60px;bottom:0;width:var(--ads);display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:5}
    .side-ads>div{writing-mode:vertical-rl;transform:rotate(180deg);opacity:.75}
    @media (max-width:1400px){.side-ads{display:none}}

    .card-actions{display:flex;gap:.5rem;align-items:center}
    .card-actions>input{min-width:0}
    .mask-blur{filter:blur(3px)}

    .badge{font-size:10px;padding:.25rem .5rem;border-radius:9999px;display:inline-flex;align-items:center;gap:.35rem}

    /* dropdown */
    .dropdown{position:relative}
    .dropdown-menu{position:absolute; right:0; top:calc(100% + .5rem); min-width:220px}

    /* avatar */
    .user-avatar{width:32px;height:32px;border-radius:9999px;background:#e5e7eb;color:#374151;display:grid;place-items:center;font-weight:700;overflow:hidden;background-size:cover;background-position:center;flex-shrink:0;font-size:14px;cursor:pointer}
    .avatar-lg{width:96px;height:96px;border-radius:9999px;background:#e5e7eb;display:grid;place-items:center;overflow:hidden;background-size:cover;background-position:center;font-weight:800;font-size:36px;color:#374151;margin:0 auto}

    .nav-mobile a{font-size:13px}

    /* lang toggle */
    .lang-toggle{padding:.25rem .5rem;border-radius:.75rem;border:1px solid rgb(229 231 235)}
    .lang-toggle span{opacity:.55}
    .lang-toggle .active{opacity:1;font-weight:700}

    /* skeleton */
    .skeleton{animation:pulse 1.2s ease-in-out infinite;background-image:linear-gradient(90deg,rgba(0,0,0,.05) 25%,rgba(0,0,0,.09) 37%,rgba(0,0,0,.05) 63%);background-size:400% 100%}
    @keyframes pulse{0%{background-position:100% 50%}100%{background-position:0 50%}}
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900">

  <!-- Top ribbon -->
  <div class="bg-emerald-600 text-white text-center text-xs sm:text-sm py-2">
    Объявления живут 24 часа · Анти‑агент фильтр включён · Нет автопродлений
  </div>

  <!-- Side ads (placeholders) -->
  <aside class="side-ads left-0"><div class="rounded-2xl bg-white border border-neutral-200 shadow-soft px-2 py-4 text-sm">Реклама</div></aside>
  <aside class="side-ads right-0"><div class="rounded-2xl bg-white border border-neutral-200 shadow-soft px-2 py-4 text-sm">Реклама</div></aside>

  <!-- Header -->
  <header class="bg-white sticky top-0 z-30 border-b border-neutral-100/80 backdrop-blur supports-[backdrop-filter]:bg-white/80">
    <div class="container mx-auto px-4 py-2 md:py-3 flex flex-col gap-2">

      <!-- Row 1 (mobile): Logo — lang — login/avatar -->
      <div class="flex items-center justify-between md:hidden">
        <a href="/" class="flex items-center gap-2 shrink-0" aria-label="На главную">
          <img src="./images/Arendatorkg.png" alt="Arendator.kg" class="w-8 h-8 rounded-full object-contain">
        </a>

        <button id="langToggleMobile" class="lang-toggle text-sm" aria-label="Переключить язык">
          <span class="ru active">Рус</span> / <span class="ky">Кыр</span>
        </button>

        <div class="flex items-center gap-2 dropdown" id="accountAreaMobile">
          <button id="btnAuthMobile" class="text-blue-600 text-sm hover:underline">Вход / регистрация</button>
          <div id="userBadgeMobile" class="hidden items-center">
            <div id="userAvatarMobile" class="user-avatar" title="Мой аккаунт"></div>
          </div>
          <div id="accountMenuMobile" class="dropdown-menu hidden bg-white border border-neutral-200 rounded-xl shadow-soft p-1">
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50">Мои объявления</button>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50">Редактировать профиль</button>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50">Изменить аватарку</button>
            <div class="h-px bg-neutral-200 my-1"></div>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50 text-red-600">Выйти</button>
          </div>
        </div>
      </div>

      <!-- Row 2 (mobile): nav compact -->
      <nav class="md:hidden nav-mobile flex flex-wrap items-center gap-3">
        <a href="post.html" class="px-3 py-1.5 rounded-xl bg-neutral-900 text-white hover:bg-neutral-800 whitespace-nowrap">Добавить объявление</a>
        <a href="sell.html" class="hover:text-blue-600 whitespace-nowrap">Продажа</a>
        <a href="blog.html" class="hover:text-blue-600 whitespace-nowrap">Блог</a>
        <a href="favorites.html" class="hover:text-blue-600 whitespace-nowrap">Избранное</a>
      </nav>

      <!-- Desktop row: Logo — Nav — spacer — Lang — Login/Avatar -->
      <div class="hidden md:flex items-center gap-4">
        <a href="/" class="flex items-center gap-2 shrink-0" aria-label="На главную">
          <img src="./images/Arendatorkg.png" alt="Arendator.kg" class="w-8 h-8 rounded-full object-contain">
        </a>

        <nav class="flex items-center gap-4 text-sm">
          <a href="post.html" class="px-3 py-1.5 rounded-xl bg-neutral-900 text-white hover:bg-neutral-800 whitespace-nowrap">Добавить объявление</a>
          <a href="sell.html" class="hover:text-blue-600 whitespace-nowrap">Продажа</a>
          <a href="blog.html" class="hover:text-blue-600 whitespace-nowrap">Блог</a>
          <a href="favorites.html" class="hover:text-blue-600 whitespace-nowrap">Избранное</a>
        </nav>

        <div class="flex-1"></div>

        <div class="hidden lg:flex items-center gap-3 text-xs text-neutral-600">
          <button id="btnSaveSearch" class="px-2 py-1 rounded-lg border border-neutral-200 hover:bg-neutral-50">Сохранить поиск</button>
          <span id="saveHint" class="hidden">Будем присылать новые совпадения</span>
        </div>

        <button id="langToggle" class="lang-toggle text-sm" aria-label="Переключить язык">
          <span class="ru active">Рус</span> / <span class="ky">Кыр</span>
        </button>

        <div class="flex items-center gap-3 text-sm dropdown" id="accountArea">
          <button id="btnAuth" class="text-blue-600 hover:underline">Вход / регистрация</button>
          <div id="userBadge" class="hidden items-center">
            <div id="userAvatar" class="user-avatar" title="Мой аккаунт"></div>
          </div>
          <div id="accountMenu" class="dropdown-menu hidden bg-white border border-neutral-200 rounded-xl shadow-soft p-1">
            <button id="menuMyAds" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50">Мои объявления</button>
            <button id="menuEditProfile" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50">Редактировать профиль</button>
            <button id="menuChangeAvatar" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50">Изменить аватарку</button>
            <div class="h-px bg-neutral-200 my-1"></div>
            <button id="menuLogout" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-50 text-red-600">Выйти</button>
          </div>
        </div>
      </div>

    </div>
  </header>

  <!-- Hero -->
  <section class="container mx-auto px-4 pt-8">
    <div class="grid md:grid-cols-2 gap-8 items-stretch">
      <!-- Left: search card -->
      <div class="bg-white border border-neutral-200 rounded-2xl shadow-soft p-4 sm:p-5 h-full flex flex-col">
        <h1 class="hero-title text-3xl md:text-5xl leading-tight text-blue-600">Найди жильё сегодня, без посредников</h1>
        <p class="mt-3 text-base md:text-lg text-neutral-600">Мы собираем свежие объявления из 30 источников, фильтруем агентов и мгновенно показываем совпадения.</p>

        <div class="mt-5 grid grid-cols-2 gap-3">
          <select id="s1" class="px-3 py-2 rounded-xl border border-neutral-200">
            <option>Снять</option><option>Сдать</option>
          </select>
          <select id="s2" class="px-3 py-2 rounded-xl border border-neutral-200">
            <option>Квартира</option><option>Комната</option><option>Дом</option>
          </select>
          <select id="s3" class="px-3 py-2 rounded-xl border border-neutral-200">
            <option>Чуй / Бш</option><option>Ыссык-Куль</option><option>Ош</option>
          </select>
          <select id="s4" class="px-3 py-2 rounded-xl border border-neutral-200">
            <option>Бишкек</option><option>Округ</option>
          </select>
          <input id="pMin" type="number" inputmode="numeric" placeholder="Цена от" class="px-3 py-2 rounded-xl border border-neutral-200">
          <input id="pMax" type="number" inputmode="numeric" placeholder="Цена до" class="px-3 py-2 rounded-xl border border-neutral-200">
        </div>

        <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="own"> от владельца</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="daily"> посуточно</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="long"> долгосрочно</label>
        </div>

        <div class="mt-3 flex flex-wrap items-center gap-3 text-sm text-neutral-600">
          <div class="badge bg-emerald-100 text-emerald-700"><span class="w-2 h-2 rounded-full bg-emerald-500"></span>Анти‑агент</div>
          <div class="badge bg-blue-100 text-blue-700"><span class="w-2 h-2 rounded-full bg-blue-600"></span>Уведомления</div>
          <div class="badge bg-neutral-100 text-neutral-700">24ч жизнь объявления</div>
        </div>

        <div class="mt-4 flex items-center gap-3 text-sm">
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="onlyNew"> только новые (≤3ч)</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="verified"> проверенные источники</label>
        </div>

        <div class="mt-auto pt-4 flex flex-wrap gap-3">
          <button id="btnApplyFiltersTop" class="px-4 py-2 rounded-xl bg-neutral-900 text-white hover:bg-neutral-800">Показать объявления</button>
          <button id="btnResetTop" class="px-4 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50">Сбросить</button>
          <div class="ml-auto flex items-center gap-2 text-sm text-neutral-600">
            <label for="sortSelect">Сортировка:</label>
            <select id="sortSelect" class="px-2 py-1 rounded-lg border border-neutral-200 text-sm">
              <option value="fresh">сначала свежие</option>
              <option value="cheap">сначала дешёвые</option>
              <option value="exp">сначала дорогие</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Right: best pick -->
      <div class="bg-white border border-neutral-200 rounded-2xl shadow-soft p-4 sm:p-5 h-full flex flex-col">
        <h3 class="text-xl md:text-2xl font-semibold text-blue-600 text-center mb-3">Лучшее совпадение за последние минуты</h3>

        <div class="rounded-xl overflow-hidden border border-neutral-200">
          <div class="aspect-[16/9] bg-neutral-100 grid place-items-center relative">
            <img id="bestImg" src="" alt="Лучшее объявление" class="w-full h-full object-cover hidden">
            <div id="bestNoPhoto" class="absolute inset-0 grid place-items-center text-neutral-500 text-sm select-none">Нет фото</div>
            <div id="bestBadges" class="absolute top-2 left-2 flex gap-2"></div>
          </div>

          <div class="p-3 flex items-center justify-center">
            <button id="bestCallBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 text-sm">
              Позвонить · <span id="bestMasked">+996 ••• •• •••</span>
            </button>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 px-3 pb-3">
            <div class="p-3 rounded-xl bg-neutral-50 border border-neutral-200">
              <div class="font-semibold" id="bestTitle"></div>
              <div class="text-neutral-600" id="bestPrice"></div>
            </div>
            <div class="p-3 rounded-xl bg-neutral-50 border border-neutral-200">
              <div class="font-semibold" id="bestDistrict"></div>
              <div class="text-neutral-600" id="bestRooms"></div>
            </div>
            <div class="p-3 rounded-xl bg-neutral-50 border border-neutral-200">
              <div class="font-semibold" id="bestMeta">Без посредников</div>
              <div class="text-neutral-600">от владельца</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Mid ad block -->
  <div class="container mx-auto px-4">
    <div id="ad-mid" class="my-6 rounded-2xl border border-neutral-200 bg-white shadow-soft grid place-items-center min-h-[100px]">
      <span class="text-sm text-neutral-500">Место для рекламы (банк · мебель · интернет)</span>
    </div>
  </div>

  <!-- Listings -->
  <main id="listings" class="container mx-auto px-4 pb-1">
    <!-- hint row -->
    <div class="flex items-center justify-between py-2 text-xs text-neutral-600">
      <div id="resultsMeta">Загружаем объявления…</div>
      <div class="hidden md:flex items-center gap-2">
        <button id="btnNotify" class="px-2 py-1 rounded-lg border border-neutral-200 hover:bg-neutral-50">Включить уведомления</button>
      </div>
    </div>

    <div id="listGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
    <div id="emptyState" class="hidden text-center py-16 text-neutral-600">По этим фильтрам нет свежих объявлений.</div>
    <div id="loader" class="hidden py-6">
      <div class="h-24 rounded-2xl bg-white border border-neutral-200 skeleton"></div>
    </div>
    <div class="flex justify-center py-6">
      <button id="btnMore" class="px-4 py-2 rounded-xl border border-neutral-200 bg-white hover:bg-neutral-50">Показать ещё</button>
    </div>
  </main>

  <!-- Pricing -->
  <section class="container mx-auto px-4 pb-10">
    <h2 class="text-2xl font-bold mb-2">Тарифы доступа</h2>
    <p class="text-neutral-700 mb-6">Лучшие варианты улетают за часы. Подписка открывает телефоны владельцев без лимита и включает уведомления о новых совпадениях.</p>

    <div class="grid sm:grid-cols-2 gap-4">
      <div class="rounded-2xl border border-neutral-200 bg-white p-5 shadow-soft">
        <div class="flex items-baseline gap-2 mb-1"><div class="text-xl font-bold">300 сом</div><div class="text-neutral-500">неделя</div></div>
        <ul class="space-y-1 text-neutral-700 text-sm mb-4">
          <li>• Телефоны владельцев без лимита</li>
          <li>• Анти‑агент фильтр — скрываем посредников</li>
          <li>• Пуш‑уведомления о новых совпадениях</li>
          <li>• Ежесекундное обновление из 30 источников</li>
        </ul>
        <button class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 pay">Открыть номера владельцев</button>
        <div class="text-xs text-neutral-500 mt-2">Если доступ не открылся сразу — быстро решим в чате или продлим время.</div>
      </div>

      <div class="rounded-2xl border border-neutral-200 bg-white p-5 shadow-soft relative">
        <span class="absolute -top-3 right-4 badge bg-amber-100 text-amber-700">Популярно</span>
        <div class="flex items-baseline gap-2 mb-1"><div class="text-xl font-bold">600 сом</div><div class="text-neutral-500">месяц</div></div>
        <ul class="space-y-1 text-neutral-700 text-sm mb-4">
          <li>• Всё из недельного тарифа</li>
          <li>• Приоритетная поддержка</li>
          <li>• 2 устройства одновременно</li>
          <li>• Бонус: сохранённые поиски</li>
        </ul>
        <button class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 pay">Открыть номера владельцев</button>
        <div class="text-xs text-neutral-500 mt-2">Автопродлений нет. Продление — вручную.</div>
      </div>
    </div>

    <details class="mt-6 rounded-2xl border border-neutral-200 bg-white p-5 shadow-soft">
      <summary class="cursor-pointer font-semibold">Частые вопросы</summary>
      <div class="mt-3 text-sm text-neutral-700 space-y-2">
        <p><b>Почему платно?</b> Мы парсим 30+ источников, фильтруем агентов и держим сервера. Плата покрывает сбор и ускоряет вам поиск.</p>
        <p><b>Можно сначала попробовать?</b> Следим за качеством: если что‑то не работает, продлим доступ.</p>
        <p><b>Списаний не будет?</b> Нет автоплатежей — контролируете сами.</p>
        <p>Каждую минуту появляется что‑то новое, а старое пропадает. Проверенные источники + ручная модерация жалоб. Безопасная оплата. Чеки и поддержка в Telegram.</p>
      </div>
    </details>

    <!-- Safety tips -->
    <div class="mt-6 rounded-2xl border border-amber-200 bg-amber-50 p-5">
      <div class="font-semibold mb-2">Безопасность аренды</div>
      <ul class="text-sm text-amber-900 space-y-1">
        <li>• Не переводите предоплату до просмотра и подписания договора.</li>
        <li>• Проверяйте документы и право собственности. Заключайте договор с владельцем.</li>
        <li>• Подозрительно дёшево? Скорее всего, фейк. Сообщите в поддержку.</li>
      </ul>
    </div>
  </section>

  <!-- Contact form -->
  <section id="contact" class="container mx-auto px-4 pb-10">
    <h2 class="text-2xl font-bold mb-3">Связаться с нами</h2>
    <p class="text-neutral-700 mb-4 text-sm">Задайте вопрос — ответим на почту в течение дня.</p>

    <form id="contactForm" class="bg-white border border-neutral-200 rounded-2xl shadow-soft p-5 grid gap-3 max-w-2xl">
      <div class="grid sm:grid-cols-2 gap-3">
        <input type="text" name="name" placeholder="Ваше имя" required class="px-3 py-2 rounded-xl border border-neutral-200">
        <input type="email" name="email" placeholder="Ваш email" required class="px-3 py-2 rounded-xl border border-neutral-200">
      </div>
      <input type="text" name="website" style="display:none">
      <input type="hidden" name="ts" id="tsField">
      <textarea name="message" rows="5" placeholder="Сообщение" required class="px-3 py-2 rounded-xl border border-neutral-200"></textarea>
      <button type="submit" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Отправить</button>
      <div id="contactNote" class="text-xs text-neutral-500"></div>
    </form>
  </section>

  <!-- Footer -->
  <footer class="border-t border-neutral-100 bg-white">
    <div class="container mx-auto px-4 py-8 grid md:grid-cols-4 gap-6 text-sm">
      <div class="md:col-span-2">
        <div class="flex items-center gap-2">
          <img src="./images/Arendatorkg.png" alt="Arendator.kg" class="w-7 h-7 rounded-full object-contain">
          <span class="font-semibold">Arendator.kg</span>
        </div>
        <p class="text-neutral-600 mt-2 max-w-[60ch]">Автоматически мониторим только свежие объявления от владельцев и проверенных источников, чтобы вы нашли жильё быстрее и без посредников.</p>
      </div>
      <div>
        <div class="font-semibold">Навигация</div>
        <ul class="mt-2 space-y-1 text-neutral-600">
          <li><a href="post.html" class="hover:text-blue-600">Добавить объявление</a></li>
          <li><a href="#sell" class="hover:text-blue-600">Продажа</a></li>
          <li><a href="blog.html" class="hover:text-blue-600">Блог</a></li>
        </ul>
      </div>
      <div>
        <div class="font-semibold">Правовое</div>
        <ul class="mt-2 space-y-1 text-neutral-600">
          <li><a class="hover:text-blue-600" href="#">Пользовательское соглашение</a></li>
          <li><a class="hover:text-blue-600" href="#">Политика конфиденциальности</a></li>
        </ul>
      </div>
    </div>
    <div class="text-center text-xs text-neutral-500 pb-6">© 2025 — Arendator.kg</div>
  </footer>

  <!-- Modals: Login / Profile / Edit / Pay -->
  <div id="modalLogin" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-soft">
      <div class="text-lg font-semibold">Вход без пароля</div>
      <p class="text-sm text-neutral-600 mt-1">Войдите по номеру — отправим код в SMS. Или через Telegram одним нажатием.</p>
      <input id="loginPhone" placeholder="0(555) 123-456" class="mt-4 w-full px-3 py-2 rounded-xl border border-neutral-200" />
      <div class="mt-3 grid grid-cols-2 gap-2">
        <button id="btnSendCode" class="px-4 py-2 rounded-xl bg-neutral-900 text-white">Отправить код</button>
        <button id="btnCloseLogin" class="px-4 py-2 rounded-xl border border-neutral-200">Закрыть</button>
      </div>
      <div id="loginStep2" class="hidden mt-4">
        <input id="loginOtp" placeholder="Код из SMS" class="w-full px-3 py-2 rounded-xl border border-neutral-200" />
        <button id="btnConfirmOtp" class="mt-3 w-full px-4 py-2 rounded-xl bg-blue-600 text-white">Войти</button>
      </div>
      <div class="my-4 flex items-center gap-3">
        <div class="h-px flex-1 bg-neutral-200"></div>
        <div class="text-xs text-neutral-500">или Telegram</div>
        <div class="h-px flex-1 bg-neutral-200"></div>
      </div>
      <div id="tgLoginContainer" class="flex justify-center"></div>
      <div class="text-xs text-neutral-500 text-center mt-2">После нажатия откроется Telegram — нажмите «Принять / Allow», чтобы завершить вход.</div>

      <div class="mt-3 text-xs text-neutral-500 text-center">или:</div>
      <div class="mt-2 grid grid-cols-2 gap-2">
        <button id="btnLoginWhatsApp" class="px-3 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50">Войти через WhatsApp</button>
        <button id="btnLoginEmail" class="px-3 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50">Войти по e‑mail</button>
      </div>

      <div id="loginEmailBlock" class="hidden mt-3 space-y-2">
        <input id="loginEmail" type="email" placeholder="you@email.com" class="w-full px-3 py-2 rounded-xl border border-neutral-200">
        <button id="btnSendEmailLink" class="w-full px-4 py-2 rounded-xl bg-neutral-900 text-white">Отправить ссылку для входа</button>
        <div class="text-xs text-neutral-500">Пришлём «магическую» ссылку на почту.</div>
      </div>
    </div>
  </div>

  <div id="modalProfile" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-soft">
      <div class="text-lg font-semibold">Мой профиль</div>
      <p class="text-sm text-neutral-600 mt-1">Измени аватарку. (Локально, без сервера)</p>

      <div class="mt-4">
        <div id="profileAvatar" class="avatar-lg">U</div>
        <div class="mt-4 grid grid-cols-2 gap-2">
          <label class="px-4 py-2 rounded-xl bg-neutral-900 text-white text-center cursor-pointer">
            <input id="avatarFile" type="file" accept="image/*" class="hidden">Загрузить
          </label>
          <button id="btnAvatarRemove" class="px-4 py-2 rounded-xl border border-neutral-200">Удалить</button>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-2 gap-2">
        <button id="btnCloseProfile" class="px-4 py-2 rounded-xl border border-neutral-200">Закрыть</button>
        <button id="btnSaveProfile" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Сохранить</button>
      </div>
    </div>
  </div>

  <div id="modalEditProfile" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-soft">
      <div class="text-lg font-semibold">Редактировать профиль</div>
      <div class="mt-4 space-y-3">
        <input id="profName" type="text" placeholder="Моё имя" class="w-full px-3 py-2 rounded-xl border border-neutral-200">
        <input id="profEmail" type="email" placeholder="E‑mail" class="w-full px-3 py-2 rounded-xl border border-neutral-200">
        <input id="profPhone" type="tel" placeholder="Телефон" class="w-full px-3 py-2 rounded-xl border border-neutral-200">
        <textarea id="profAbout" rows="4" placeholder="Обо мне" class="w-full px-3 py-2 rounded-xl border border-neutral-200"></textarea>
      </div>
      <div class="mt-6 grid grid-cols-2 gap-2">
        <button id="btnCloseEditProfile" class="px-4 py-2 rounded-xl border border-neutral-200">Отмена</button>
        <button id="btnSaveEditProfile" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Сохранить</button>
      </div>
    </div>
  </div>

  <div id="modalPay" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-soft">
      <div class="text-lg font-semibold">Открой номера владельцев</div>
      <p class="text-sm text-neutral-600 mt-1">После оплаты доступ активируется автоматически. Никаких автопродлений.</p>
      <div class="mt-4 grid grid-cols-3 gap-2 text-sm">
        <button class="pay-method px-3 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50" data-method="mbank">MBank QR</button>
        <button class="pay-method px-3 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50" data-method="elqr">ELQR</button>
        <button class="pay-method px-3 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50" data-method="card">Карта</button>
      </div>
      <div id="paySelected" class="mt-4 text-sm text-neutral-700 hidden">Вы выбрали: <span class="font-medium" id="payMethodName"></span></div>
      <div class="mt-4 grid grid-cols-2 gap-2">
        <button id="btnSimulatePaid" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Оплата прошла (демо)</button>
        <button id="btnClosePay" class="px-4 py-2 rounded-xl border border-neutral-200">Отмена</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-xl bg-neutral-900 text-white text-sm"></div>

  <script>
    /* ===== Demo data ===== */
    const listings = [
      { id:'l1', title:'2к, Центр, свежий ремонт', price:35000, district:'Центр', rooms:'2', daily:false, owner:true, verified:true, img:'', phone:'+996555123456', expiresAt: Date.now()+23*3600e3+30*60e3, createdAt: Date.now()-2*3600e3 },
      { id:'l2', title:'1к, Майевка, уютная',      price:18000, district:'Майевка', rooms:'1', daily:false, owner:true, verified:true, img:'https://images.unsplash.com/photo-1502005229762-cf1b2da7cda7?q=80&w=1200&auto=format&fit=crop', phone:'+996700222333', expiresAt: Date.now()+10*3600e3, createdAt: Date.now()-1*3600e3 },
      { id:'l3', title:'3к, Асанбай, вид на горы', price:55000, district:'Асанбай', rooms:'3+',daily:false, owner:false, verified:false,img:'https://images.unsplash.com/photo-1560066984-138dadb4c035?q=80&w=1200&auto=format&fit=crop', phone:'+996777444555', expiresAt: Date.now()+6*3600e3, createdAt: Date.now()-7*3600e3 },
      { id:'l4', title:'Студия, Московский',       price:22000, district:'Московский',rooms:'1', daily:false, owner:true, verified:true, img:'https://images.unsplash.com/photo-1493809842364-78817add7ffb?q=80&w=1200&auto=format&fit=crop', phone:'+996555987654', expiresAt: Date.now()+12*3600e3, createdAt: Date.now()-50*60*1000 },
      { id:'l5', title:'Посуточно 2к, Центр',      price:3000,  district:'Центр', rooms:'2', daily:true,  owner:true, verified:true, img:'https://images.unsplash.com/photo-1502823403499-6ccfcf4fb453?q=80&w=1200&auto=format&fit=crop', phone:'+996709111222', expiresAt: Date.now()+20*3600e3, createdAt: Date.now()-30*60*1000 },
      { id:'l6', title:'3к, Свердловский, новая мебель', price:45000, district:'Свердловский', rooms:'3+', daily:false, owner:true, verified:false, img:'https://images.unsplash.com/photo-1494526585095-c41746248156?q=80&w=1200&auto=format&fit=crop', phone:'+996500321654', expiresAt: Date.now()+5*3600e3, createdAt: Date.now()-10*3600e3 },
    ];

    /* ===== Utils ===== */
    const qs  = (s,el=document)=>el.querySelector(s);
    const qsa = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const showToast=(m)=>{const t=qs('#toast'); t.textContent=m; t.classList.remove('hidden'); clearTimeout(showToast.t); showToast.t=setTimeout(()=>t.classList.add('hidden'),2200);};
    const hasAccess=()=>Date.now() < Number(localStorage.getItem('accessUntil')||0);
    const setAccess=(h=24)=>{ localStorage.setItem('accessUntil', String(Date.now()+h*3600e3)); showToast('Доступ открыт на 24 часа'); render(); };
    const maskPhone=(p)=> p ? p.replace(/(\+\d{3})\d+/, '$1 ••• •• •••') : '•••';

    function countdown(el, ts){
      function tick(){
        const d=ts-Date.now(); if(d<=0){ el.textContent='0ч 00м'; return; }
        const h=Math.floor(d/3600000), m=Math.floor((d%3600000)/60000);
        el.textContent = `${h}ч ${String(m).padStart(2,'0')}м`;
      }
      tick(); return setInterval(tick,60000);
    }

    const timeAgo = (ms)=>{
      const d = Date.now()-ms; const m = Math.floor(d/60000); if (m<1) return 'только что'; if (m<60) return m+' мин назад'; const h=Math.floor(m/60); return h+' ч назад';
    }

    /* ===== Best pick ===== */
    let bestItem = null;
    function renderBest(){
      bestItem = listings.find(it=>!it.daily && it.price<=25000) || listings[0];
      const imgEl = qs('#bestImg');
      const noPhoto = qs('#bestNoPhoto');
      const btn = qs('#bestCallBtn');
      const masked = qs('#bestMasked');
      const badges = qs('#bestBadges');

      if (bestItem.img) { imgEl.src = bestItem.img; imgEl.alt = bestItem.title || 'Лучшее объявление'; imgEl.classList.remove('hidden'); noPhoto.classList.add('hidden'); }
      else { imgEl.removeAttribute('src'); imgEl.classList.add('hidden'); noPhoto.classList.remove('hidden'); }

      masked.textContent = maskPhone(bestItem.phone || '');
      badges.innerHTML = '';
      if (bestItem.verified) badges.insertAdjacentHTML('beforeend', '<span class="badge bg-emerald-100 text-emerald-700">Проверено</span>');
      if (Date.now()-bestItem.createdAt < 3*3600e3) badges.insertAdjacentHTML('beforeend', '<span class="badge bg-blue-100 text-blue-700">Новое</span>');

      qs('#bestTitle').textContent = bestItem.title || '';
      qs('#bestPrice').textContent = (bestItem.price || 0).toLocaleString('ru-RU') + (bestItem.daily?' сом/сут':' сом/мес');
      qs('#bestDistrict').textContent = bestItem.district || '';
      qs('#bestRooms').textContent = 'Комнат: ' + (bestItem.rooms || '');
      qs('#bestMeta').textContent = bestItem.owner ? 'Без посредников' : 'Источник';

      btn.onclick = () => {
        if(!localStorage.getItem('userLogged')){ openLogin(); return; }
        if(!hasAccess()){ openPay(); return; }
        if(bestItem?.phone){ location.href = `tel:${bestItem.phone}`; }
      };
    }

    /* ===== Cards ===== */
    function cardHTML(it){
      const priceUnit = it.daily ? 'сом/сут' : 'сом/мес';
      const favs = new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
      const isFav = favs.has(it.id);
      const isNew = (Date.now()-it.createdAt) < 3*3600e3;
      return `
      <article class="rounded-2xl border border-neutral-200 bg-white overflow-hidden shadow-sm hover:shadow-md transition-shadow flex flex-col h-full">
        <div class="relative aspect-[4/3] overflow-hidden grid place-items-center bg-neutral-100">
          ${it.img ? `<img src="${it.img}" alt="${it.title}" class="w-full h-full object-cover">` : `<div class="w-full h-full skeleton"></div>`}
          <div class="absolute top-2 left-2 flex gap-2">
            ${it.owner ? '<span class="badge bg-emerald-100 text-emerald-700">Без посредников</span>' : '<span class="badge bg-neutral-100 text-neutral-700">Источник</span>'}
            ${it.verified ? '<span class="badge bg-emerald-100 text-emerald-700">Проверено</span>' : ''}
            ${isNew ? '<span class="badge bg-blue-100 text-blue-700">Новое</span>' : ''}
          </div>
        </div>
        <div class="p-4 flex-1 flex flex-col gap-3">
          <div class="flex items-start gap-2">
            <h3 class="font-semibold leading-snug">${it.title}</h3>
          </div>
          <div class="flex items-center gap-2">
            <div class="text-2xl font-bold">${it.price.toLocaleString('ru-RU')} <span class="text-sm font-medium text-neutral-500">${priceUnit}</span></div>
            <div class="ml-auto text-xs text-neutral-600" title="время до удаления">осталось <span class="countdown" data-ts="${it.expiresAt}"></span></div>
          </div>
          <div class="flex items-center gap-2 text-sm text-neutral-600">
            <div>${it.district}</div><div>·</div><div>Комнат: ${it.rooms}</div><div>·</div><div title="когда добавлено">${timeAgo(it.createdAt)}</div>
          </div>
          <div class="mt-auto card-actions">
            <input readonly class="flex-1 px-3 py-2 rounded-xl border border-neutral-200 bg-neutral-50 ${hasAccess()?'':'mask-blur'}" value="${it.phone}">
            <button class="px-3 py-2 rounded-xl bg-blue-600 text-white text-sm reveal-btn" data-id="${it.id}">${hasAccess()?'Скопировать':'Показать номер'}</button>
          </div>
          <div class="flex items-center justify-between text-xs text-neutral-500 pt-1">
            <button class="fav-btn hover:text-blue-600 inline-flex items-center gap-1" data-id="${it.id}" title="В избранное"><span class="heart ${isFav?'text-red-600':''}">${isFav?'❤':'♡'}</span> В избранное</button>
            <span class="hidden sm:inline">ID: ${it.id}</span>
          </div>
        </div>
      </article>`;
    }

    function renderListings(data){
      const grid=qs('#listGrid'); grid.innerHTML='';
      if(!data.length){ qs('#emptyState').classList.remove('hidden'); return; }
      qs('#emptyState').classList.add('hidden');
      data.forEach(it=> grid.insertAdjacentHTML('beforeend', cardHTML(it)));
      qsa('.countdown').forEach(el=>countdown(el, Number(el.dataset.ts)));
      qsa('.reveal-btn').forEach(btn=>btn.addEventListener('click', onRevealClick));
      qsa('.fav-btn').forEach(btn=>btn.addEventListener('click', onFavClick));
      qs('#resultsMeta').textContent = `Показано ${data.length} объявлений`;
    }

    function onRevealClick(e){
      const btn=e.currentTarget;
      if(!localStorage.getItem('userLogged')){ openLogin(); return; }
      if(!hasAccess()){ openPay(); return; }
      const input=btn.closest('article').querySelector('input');
      navigator.clipboard.writeText(input.value).then(()=>showToast('Номер скопирован'));
    }

    function onFavClick(e){
      if(!localStorage.getItem('userLogged')){ openLogin(); return; }
      const id=e.currentTarget.dataset.id;
      const favs=new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
      const heart=e.currentTarget.querySelector('.heart');
      if(favs.has(id)){favs.delete(id); heart.textContent='♡'; heart.classList.remove('text-red-600'); showToast('Убрано из избранного');}
      else {favs.add(id); heart.textContent='❤'; heart.classList.add('text-red-600'); showToast('Добавлено в избранное');}
      localStorage.setItem('favs', JSON.stringify([...favs]));
    }

    /* ===== Save search & notifications (demo) ===== */
    qs('#btnSaveSearch')?.addEventListener('click', ()=>{
      localStorage.setItem('saved_search', JSON.stringify(getCurrentFilters()));
      qs('#saveHint')?.classList.remove('hidden');
      showToast('Поиск сохранён');
    });
    qs('#btnNotify')?.addEventListener('click', async ()=>{
      try{ await Notification.requestPermission(); }catch(_){}
      showToast('Уведомления включены (демо)');
    });

    /* ===== Modals ===== */
    const modalLogin=qs('#modalLogin'), modalPay=qs('#modalPay'), modalProfile=qs('#modalProfile'), modalEdit=qs('#modalEditProfile');
    function openLogin(){ modalLogin.classList.remove('hidden'); modalLogin.classList.add('flex'); }
    function closeLogin(){ modalLogin.classList.add('hidden'); modalLogin.classList.remove('flex'); }
    function openPay(){ modalPay.classList.remove('hidden'); modalPay.classList.add('flex'); }
    function closePay(){ modalPay.classList.add('hidden'); modalPay.classList.remove('flex'); }
    function openProfile(){ modalProfile.classList.remove('hidden'); modalProfile.classList.add('flex'); syncProfileModal(); }
    function closeProfile(){ modalProfile.classList.add('hidden'); modalProfile.classList.remove('flex'); }
    function openEdit(){ fillEditProfileModal(); modalEdit.classList.remove('hidden'); modalEdit.classList.add('flex'); }
    function closeEdit(){ modalEdit.classList.add('hidden'); modalEdit.classList.remove('flex'); }

    /* Telegram widget (lazy) */
    function mountTelegramWidget(){
      if (qs('#tgLoginContainer script')) return;
      const s=document.createElement('script');
      s.src='https://telegram.org/js/telegram-widget.js?22';
      s.async=true;
      s.setAttribute('data-telegram-login','ArendatorKGbot');
      s.setAttribute('data-size','large');
      s.setAttribute('data-userpic','false');
      s.setAttribute('data-request-access','write');
      s.setAttribute('data-auth-url','/api/tg-login');
      qs('#tgLoginContainer').appendChild(s);
    }

    window.addEventListener('message', (ev) => {
      const msg = ev.data || {};
      if (msg && msg.type === 'tg-auth') {
        if (msg.ok) {
          try{ localStorage.setItem('userLogged','1'); }catch(_){ }
          try{ localStorage.setItem('tg_user', JSON.stringify(msg.user||{})); }catch(_){ }
          try{ closeLogin(); }catch(_){ }
          try{ showToast('Вход через Telegram выполнен'); }catch(_){ }
          try{ updateAuthUI(); render(); }catch(_){ }
        } else {
          try{ showToast('Не удалось войти через Telegram'); }catch(_){ }
        }
      }
    }, false);

    function hasAuthCookie(){ return document.cookie.split("; ").some(c => c.trim().startsWith("auth=")); }
    function syncAuthFromCookieAndQuery(){
      const p = new URLSearchParams(location.search);
      if (p.get("tg") === "ok" || hasAuthCookie()) {
        try { localStorage.setItem("userLogged", "1"); } catch(e){}
        if (p.get("tg") === "ok") { history.replaceState(null, "", location.pathname); }
      }
    }

    function setLangUI(lang){ qsa('#langToggle .ru, #langToggleMobile .ru').forEach(el=>el.classList.toggle('active', lang==='ru')); qsa('#langToggle .ky, #langToggleMobile .ky').forEach(el=>el.classList.toggle('active', lang==='ky')); }
    function initLang(){
      const lang = localStorage.getItem('lang') || 'ru';
      setLangUI(lang);
      const bind = id => { const el = qs(id); if(!el) return; el.addEventListener('click', ()=>{ const cur = localStorage.getItem('lang') || 'ru'; const next = cur==='ru' ? 'ky' : 'ru'; localStorage.setItem('lang', next); setLangUI(next); }); };
      bind('#langToggle');
      bind('#langToggleMobile');
    }

    function updateAuthUI(){
      const logged  = !!localStorage.getItem('userLogged');
      const btn     = qs('#btnAuth');
      const badge   = qs('#userBadge');
      const avatar  = qs('#userAvatar');
      const btnM    = qs('#btnAuthMobile');
      const badgeM  = qs('#userBadgeMobile');
      const avatarM = qs('#userAvatarMobile');
      if (btn) btn.textContent  = logged ? 'Мой аккаунт' : 'Вход / регистрация';
      if (btnM) btnM.textContent = logged ? 'Аккаунт' : 'Вход / регистрация';
      const applyUser = (avatarEl, badgeEl) => {
        if (!avatarEl || !badgeEl) return;
        if (!logged){ badgeEl.classList.add('hidden'); avatarEl.style.backgroundImage=''; avatarEl.textContent=''; return; }
        let u={}; try{u=JSON.parse(localStorage.getItem('tg_user')||'{}')}catch(_){ }
        const localAvatar = localStorage.getItem('avatar_url') || '';
        const initial = (u.first_name?.trim()?.[0] || u.username?.trim()?.[0] || 'U').toUpperCase();
        avatarEl.style.backgroundImage=''; avatarEl.textContent=initial;
        const imgUrl = localAvatar || u.photo_url || '';
        if (imgUrl){ avatarEl.style.backgroundImage=`url("${imgUrl}")`; avatarEl.textContent=''; }
        badgeEl.classList.remove('hidden');
      };
      applyUser(avatar, badge);
      applyUser(avatarM, badgeM);
    }

    qs('#btnCloseLogin').addEventListener('click', closeLogin);
    qs('#btnSendCode').addEventListener('click', ()=>{ qs('#loginStep2').classList.remove('hidden'); showToast('Код отправлен (демо)'); });
    qs('#btnConfirmOtp').addEventListener('click', ()=>{ localStorage.setItem('userLogged', '1'); closeLogin(); updateAuthUI(); showToast('Вход выполнен'); });

    qsa('.pay').forEach(b=>b.addEventListener('click', openPay));
    qsa('.pay-method').forEach(b=> b.addEventListener('click', ()=>{ qs('#paySelected').classList.remove('hidden'); qs('#payMethodName').textContent=b.textContent; }));
    qs('#btnClosePay').addEventListener('click', closePay);
    qs('#btnSimulatePaid').addEventListener('click', ()=>{ setAccess(24); closePay(); });

    document.addEventListener('click', (ev) => {
      const trg = ev.target.closest('#btnAuth, #btnAuthMobile, #userAvatar, #userAvatarMobile');
      if (trg){ const logged = !!localStorage.getItem('userLogged'); const isMobile = !!ev.target.closest('#accountAreaMobile'); const menu = isMobile ? qs('#accountMenuMobile') : qs('#accountMenu'); if (logged){ menu?.classList.toggle('hidden'); } else { openLogin(); mountTelegramWidget(); } return; }
      if (!ev.target.closest('#accountMenu') && !ev.target.closest('#accountArea')) { qs('#accountMenu')?.classList.add('hidden'); }
      if (!ev.target.closest('#accountMenuMobile') && !ev.target.closest('#accountAreaMobile')) { qs('#accountMenuMobile')?.classList.add('hidden'); }
    });

    function fillEditProfileModal(){ const p = JSON.parse(localStorage.getItem('profile')||'{}'); qs('#profName').value  = p.name  || ''; qs('#profEmail').value = p.email || ''; qs('#profPhone').value = p.phone || ''; qs('#profAbout').value = p.about || ''; }
    qs('#btnCloseEditProfile').addEventListener('click', closeEdit);
    qs('#btnSaveEditProfile').addEventListener('click', ()=>{ const data = { name : qs('#profName').value.trim(), email: qs('#profEmail').value.trim(), phone: qs('#profPhone').value.trim(), about: qs('#profAbout').value.trim() }; localStorage.setItem('profile', JSON.stringify(data)); closeEdit(); updateAuthUI(); showToast('Профиль сохранён'); });

    qs('#btnCloseProfile').addEventListener('click', closeProfile);
    qs('#btnSaveProfile').addEventListener('click', ()=>{ closeProfile(); showToast('Профиль сохранён'); updateAuthUI(); });

    qs('#avatarFile').addEventListener('change', async (e)=>{ const file = e.target.files?.[0]; if (!file) return; try{ const dataUrl = await fileToAvatarDataURL(file, 256); localStorage.setItem('avatar_url', dataUrl); syncProfileModal(); updateAuthUI(); showToast('Аватар обновлён'); }catch(err){ showToast('Не удалось обработать изображение'); } });
    qs('#btnAvatarRemove').addEventListener('click', ()=>{ localStorage.removeItem('avatar_url'); syncProfileModal(); updateAuthUI(); showToast('Аватар удалён'); });

    function syncProfileModal(){ const box = qs('#profileAvatar'); let u = {}; try { u = JSON.parse(localStorage.getItem('tg_user')||'{}'); } catch(_){} const initial = (u.first_name?.trim()?.[0] || u.username?.trim()?.[0] || 'U').toUpperCase(); const localAvatar = localStorage.getItem('avatar_url'); box.style.backgroundImage = ''; box.textContent = initial; if (localAvatar) { box.style.backgroundImage = `url(${localAvatar})`; box.textContent = ''; } else if (u.photo_url) { box.style.backgroundImage = `url(${u.photo_url})`; box.textContent = ''; } }

    function fileToAvatarDataURL(file, size=256){ return new Promise((resolve, reject)=>{ const img = new Image(); img.onload = ()=>{ const s = Math.min(img.width, img.height); const sx = (img.width - s)/2; const sy = (img.height - s)/2; const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size; const ctx = canvas.getContext('2d'); ctx.drawImage(img, sx, sy, s, s, 0, 0, size, size); const out = canvas.toDataURL('image/jpeg', 0.85); resolve(out); }; img.onerror = reject; const reader = new FileReader(); reader.onload = () => { img.src = reader.result; }; reader.onerror = reject; reader.readAsDataURL(file); }); }

    /* ===== Filters / Sort / Render ===== */
    function getCurrentFilters(){ return { priceMin: Number(qs('#pMin').value || 0), priceMax: Number(qs('#pMax').value || Infinity), onlyOwn: qs('#own').checked, onlyDaily: qs('#daily').checked, onlyLong: qs('#long').checked, onlyNew: qs('#onlyNew').checked, verified: qs('#verified').checked, sort: qs('#sortSelect').value }; }

    function applyFilters(){
      const f = getCurrentFilters();
      let out=listings.filter(it=>( it.price>=f.priceMin && it.price<=f.priceMax && (!f.onlyOwn || it.owner) && (!f.onlyDaily || it.daily) && (!f.onlyLong || !it.daily) && (!f.onlyNew || (Date.now()-it.createdAt)<=3*3600e3) && (!f.verified || it.verified) ));
      if (f.sort==='cheap') out.sort((a,b)=>a.price-b.price); else if (f.sort==='exp') out.sort((a,b)=>b.price-a.price); else out.sort((a,b)=>b.createdAt-a.createdAt);
      renderListings(out);
    }

    /* ===== Infinite load (demo) ===== */
    qs('#btnMore').addEventListener('click', ()=>{ qs('#loader').classList.remove('hidden'); setTimeout(()=>{ const more = listings.map(x=>({ ...x, id: x.id+Math.random().toString(36).slice(2,6), createdAt: Date.now()-Math.floor(Math.random()*6)*3600e3 })); listings.push(...more.slice(0,5)); qs('#loader').classList.add('hidden'); applyFilters(); }, 600); });

    function render(){ renderBest(); applyFilters(); updateAuthUI(); }

    document.addEventListener('DOMContentLoaded', () => { try { syncAuthFromCookieAndQuery(); } catch(e){} try { initLang(); } catch(e){} try { render(); } catch(e){} });

    window.addEventListener('storage', (e) => { if (['userLogged', 'avatar_url', 'tg_user', 'lang'].includes(e.key)) { try { updateAuthUI(); } catch(e){} if (e.key === 'lang') try { setLangUI(localStorage.getItem('lang')||'ru'); } catch(e){} } });
  </script>

  <!-- Secondary script: WhatsApp / Email + Contact form -->
  <script>
  (() => {
    const waBtn   = document.getElementById('btnLoginWhatsApp');
    const emBtn   = document.getElementById('btnLoginEmail');
    const emBox   = document.getElementById('loginEmailBlock');
    const emInput = document.getElementById('loginEmail');
    const emSend  = document.getElementById('btnSendEmailLink');

    const WA_NUMBER = '996555123456';

    if (waBtn) { waBtn.addEventListener('click', () => { const text = encodeURIComponent('Здравствуйте! Хочу войти в Arendator.kg'); window.open(`https://wa.me/${WA_NUMBER}?text=${text}`, '_blank'); }); }
    if (emBtn) { emBtn.addEventListener('click', () => { emBox?.classList.toggle('hidden'); }); }
    if (emSend) {
      emSend.addEventListener('click', async () => {
        const email = (emInput?.value || '').trim();
        if (!email) { alert('Укажи e‑mail'); return; }
        const magic = Math.random().toString(36).slice(2);
        try { localStorage.setItem('email_magic_' + email, magic); } catch(_){ }
        const link = `${location.origin}/?login=${encodeURIComponent(email)}&magic=${magic}`;
        const html = `<p>Привет! Для входа в Arendator.kg нажми ссылку:</p><p><a href="${link}">Войти</a></p><p>Если это были не вы — просто игнорируйте письмо.</p>`;
        try {
          const res = await fetch('/api/send-mail', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ to: email, subject: 'Вход в Arendator.kg', html }) });
          const data = await res.json(); if (data.ok) { alert('Ссылка отправлена на почту.'); } else { alert('Не удалось отправить: ' + (data.error || 'ошибка')); }
        } catch (e) { alert('Сеть недоступна, попробуй ещё раз.'); }
      });
    }

    (function emailMagicAutoLogin(){ const p = new URLSearchParams(location.search); const email = p.get('login'); const magic = p.get('magic'); if (!email || !magic) return; try { const saved = localStorage.getItem('email_magic_' + email); if (saved && saved === magic) { localStorage.setItem('userLogged', '1'); history.replaceState(null, '', location.pathname); try { document.getElementById('modalLogin')?.classList.add('hidden'); } catch(_){} try { const t = document.getElementById('toast'); if (t){ t.textContent='Вход по email выполнен'; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2000); } } catch(_){} } } catch(_){} })();

    const ts = document.getElementById('tsField'); if (ts) ts.value = Date.now();
    const form = document.getElementById('contactForm'); const note = document.getElementById('contactNote');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault(); const fd = new FormData(form); const payload = Object.fromEntries(fd.entries());
        if (payload.website && payload.website.trim() !== '') { form.reset(); if (note) note.textContent = 'Спасибо!'; return; }
        payload.to = 'reply@arendator.kg';
        try { const res = await fetch('/api/send-mail', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); const data = await res.json(); if (data.ok) { form.reset(); if (note) note.textContent = 'Сообщение отправлено.'; if (ts) ts.value = Date.now(); } else { if (note) note.textContent = 'Ошибка: ' + (data.error || 'не удалось отправить'); } } catch (err) { if (note) note.textContent = 'Ошибка сети. Попробуйте ещё раз.'; }
      });
    }
  })();
  </script>
</body>
</html>
