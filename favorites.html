<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title data-i18n-title>Избранное — Arendator.kg</title>
  <link rel="icon" href="./images/Arendatorkg.png">
  <link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--container:1180px}
    .container{max-width:var(--container)}
    .shadow-soft{box-shadow:0 8px 30px rgba(0,0,0,.08)}
    html,body{overflow-x:hidden;font-family:'Onest',system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    .lang-toggle{padding:.25rem .5rem;border:1px solid rgb(229 231 235);border-radius:.75rem}
    .lang-toggle span{opacity:.55}
    .lang-toggle .active{opacity:1;font-weight:700}
    .tg-ico{display:inline-flex;align-items:center;margin-right:.5rem}
    .tg-ico svg{width:18px;height:18px}
    .ph-wrap{display:flex;align-items:center;justify-content:center;width:100%;height:100%;color:#9aa1ab}
    .ph-text{font-size:12px;color:#818b98;margin-top:6px}
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900">

  <div id="topline" class="bg-emerald-600 text-white text-center text-xs sm:text-sm py-2">
    Объявления живут 24 часа · Анти-агент фильтр включён · Контакты — в Telegram
  </div>

  <header class="bg-white sticky top-0 z-30 border-b border-neutral-100/80">
    <div class="container mx-auto px-4 py-2 md:py-3">
      <div class="flex flex-wrap items-center gap-3">
        <a href="index.html" class="order-1 flex items-center gap-2 shrink-0">
          <img src="./images/Arendatorkg.png" alt="Arendator.kg" class="w-8 h-8 rounded-full object-contain">
        </a>

        <nav id="nav" class="order-3 w-full mt-2 grid grid-cols-3 gap-2 text-sm
                    md:order-2 md:w-auto md:mt-0 md:grid-cols-none md:flex md:flex-1 md:justify-center md:gap-3">
          <a id="navBlog" href="blog.html" class="w-full px-3 py-1.5 text-center rounded-xl border border-neutral-200 hover:bg-neutral-50">Блог</a>
          <a id="navPost" href="post.html" class="w-full px-3 py-1.5 text-center rounded-xl bg-neutral-900 text-white hover:bg-neutral-800">Добавить объявление</a>
          <a id="navFav" href="favorites.html?v=3" class="w-full px-3 py-1.5 text-center rounded-xl border border-neutral-200 hover:bg-neutral-50">Избранное</a>
        </nav>

        <button id="langToggle" class="order-2 md:order-3 ml-auto lang-toggle text-sm" type="button">
          <span class="ru active">Рус</span> / <span class="ky">Кыр</span>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 md:py-8">
    <h1 id="pageTitle" class="text-2xl md:text-3xl font-bold mb-4">Избранное</h1>

    <div id="empty" class="hidden rounded-2xl border border-neutral-200 bg-white shadow-soft p-10 text-center text-neutral-600">
      <div id="emptyText" class="mb-2">Пока пусто: ничего не выбрано.</div>
      <div class="mt-3">
        <a id="emptyBack" href="index.html#feed" class="text-blue-600 hover:underline">Вернуться и выбрать объявления</a>
      </div>
    </div>

    <div id="grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-2 sm:gap-4"></div>
  </main>

  <section id="contact" class="container mx-auto px-4 pb-10">
    <h2 id="contactTitle" class="text-2xl font-bold mb-3">Связаться с нами</h2>
    <p id="contactLead" class="text-neutral-700 mb-4 text-sm">Задайте вопрос — ответим на почту в течение дня.</p>

    <form id="contactForm" class="bg-white border border-neutral-200 rounded-2xl shadow-soft p-5 grid gap-3 max-w-2xl">
      <div class="grid sm:grid-cols-2 gap-3">
        <input id="fName" type="text" name="name" placeholder="Ваше имя" required class="px-3 py-2 rounded-xl border border-neutral-200">
        <input id="fEmail" type="email" name="email" placeholder="Ваш email" required class="px-3 py-2 rounded-xl border border-neutral-200">
      </div>
      <input type="text" name="website" style="display:none">
      <input type="hidden" name="ts" id="tsField">
      <textarea id="fMsg" name="message" rows="5" placeholder="Сообщение" required class="px-3 py-2 rounded-xl border border-neutral-200"></textarea>
      <button id="fSend" type="submit" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Отправить</button>
      <div id="contactNote" class="text-xs text-neutral-500"></div>
    </form>
  </section>

  <footer class="border-t border-neutral-100 bg-white">
    <div class="container mx-auto px-4 py-8 grid md:grid-cols-4 gap-6 text-sm">
      <div class="md:col-span-2">
        <div class="flex items-center gap-2">
          <img src="./images/Arendatorkg.png" alt="Arendator.kg" class="w-7 h-7 rounded-full object-contain">
          <span class="font-semibold">Arendator.kg</span>
        </div>
        <p id="footerAbout" class="text-neutral-600 mt-2 max-w-[60ch]">
          Автоматически мониторим свежие объявления от владельцев и проверенных источников — быстрее и без посредников.
        </p>
      </div>
      <div>
        <div id="footerNav" class="font-semibold">Навигация</div>
        <ul class="mt-2 space-y-1 text-neutral-600">
          <li><a id="fAdd" href="post.html" class="hover:text-blue-600">Добавить объявление</a></li>
          <li><a id="fBlog" href="blog.html" class="hover:text-blue-600">Блог</a></li>
          <li><a id="fFav" href="favorites.html?v=3" class="hover:text-blue-600">Избранное</a></li>
        </ul>
      </div>
      <div>
        <div id="footerLegal" class="font-semibold">Правовое</div>
        <ul class="mt-2 space-y-1 text-neutral-600">
          <li><a id="fDel" class="hover:text-blue-600" href="data-deletion.html">Удаление данных</a></li>
          <li><a id="fPriv" class="hover:text-blue-600" href="#">Политика конфиденциальности</a></li>
        </ul>
      </div>
    </div>
    <div id="footerCopy" class="text-center text-xs text-neutral-500 pb-6">© 2025 — Arendator.kg</div>
  </footer>

  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-xl bg-neutral-900 text-white text-sm"></div>

  <script>
    // ===== i18n =====
    const I18N = {
      ru: {
        title: 'Избранное — Arendator.kg',
        topline: 'Объявления живут 24 часа · Анти-агент фильтр включён · Контакты — в Telegram',
        nav_blog: 'Блог', nav_add: 'Добавить объявление', nav_fav: 'Избранное',
        page_title: 'Избранное',
        empty: 'Пока пусто: ничего не выбрано.',
        empty_back: 'Вернуться и выбрать объявления',
        tg_btn: 'Получить номер в Telegram',
        no_photo: 'ФОТО НЕ ПРЕДОСТАВИЛИ — нет фотографий в обьявлении',
        remove: 'Удалить',
        toast_removed: 'Убрано из избранного',
        contact_title: 'Связаться с нами',
        contact_lead: 'Задайте вопрос — ответим на почту в течение дня.',
        f_name: 'Ваше имя', f_email: 'Ваш email', f_msg: 'Сообщение', f_send: 'Отправить',
        sent_ok: 'Сообщение отправлено.',
        sent_err: 'Ошибка: не удалось отправить',
        net_err: 'Ошибка сети. Попробуйте ещё раз.',
        footer_about: 'Автоматически мониторим свежие объявления от владельцев и проверенных источников — быстрее и без посредников.',
        footer_nav: 'Навигация', footer_legal: 'Правовое',
        footer_del: 'Удаление данных', footer_priv: 'Политика конфиденциальности',
        currency: ' сом',
        price_contract: 'Договорная'
      },
      ky: {
        title: 'Тандалгандар — Arendator.kg',
        topline: 'Жарыялар 24 саат жарактуу · Агент фильтри күйгүзүлгөн · Байланыш — Telegram\'да',
        nav_blog: 'Блог', nav_add: 'Жарнама кошуу', nav_fav: 'Тандалгандар',
        page_title: 'Тандалгандар',
        empty: 'Азырынча эч нерсе тандалган жок.',
        empty_back: 'Лентага кайтуу жана жарыяларды тандоо',
        tg_btn: 'Telegram аркылуу номерди алуу',
        no_photo: 'Сүрөт жок',
        remove: 'Өчүрүү',
        toast_removed: 'Тандалгандардан алынды',
        contact_title: 'Биз менен байланыш',
        contact_lead: 'Суроо бериңиз — күн ичинде почта аркылуу жооп беребиз.',
        f_name: 'Атыңыз', f_email: 'Сиздин email', f_msg: 'Билдирме', f_send: 'Жөнөтүү',
        sent_ok: 'Билдирме жөнөтүлдү.',
        sent_err: 'Ката: жөнөтүү мүмкүн эмес',
        net_err: 'Тармак катасы. Кайра аракет кылыңыз.',
        footer_about: 'Биз ээлерден жана текшерилген булактардан жаңы жарыяларды көзөмөлдөп турабыз — ортомчусуз жана тез.',
        footer_nav: 'Навигация', footer_legal: 'Юридикалык',
        footer_del: 'Маалыматты өчүрүү', footer_priv: 'Купуялык саясаты',
        currency: ' сом',
        price_contract: 'Макулдашылат'
      }
    };

    // ===== lang helpers =====
    function getLang(){ return localStorage.getItem('lang') || (document.documentElement.lang || 'ru'); }
    function applyLang(l){
      document.documentElement.lang = l;
      const t = I18N[l];
      document.querySelector('[data-i18n-title]').textContent = t.title;
      document.getElementById('topline').textContent = t.topline;
      document.getElementById('navBlog').textContent = t.nav_blog;
      document.getElementById('navPost').textContent = t.nav_add;
      document.getElementById('navFav').textContent = t.nav_fav;
      document.getElementById('pageTitle').textContent = t.page_title;
      document.getElementById('emptyText').textContent = t.empty;
      document.getElementById('emptyBack').textContent = t.empty_back;
      document.getElementById('contactTitle').textContent = t.contact_title;
      document.getElementById('contactLead').textContent = t.contact_lead;
      document.getElementById('fName').placeholder = t.f_name;
      document.getElementById('fEmail').placeholder = t.f_email;
      document.getElementById('fMsg').placeholder = t.f_msg;
      document.getElementById('fSend').textContent = t.f_send;
      document.getElementById('footerAbout').textContent = t.footer_about;
      document.getElementById('footerNav').textContent = t.footer_nav;
      document.getElementById('footerLegal').textContent = t.footer_legal;
      document.getElementById('fAdd').textContent = t.nav_add;
      document.getElementById('fBlog').textContent = t.nav_blog;
      document.getElementById('fFav').textContent = t.nav_fav;
      document.getElementById('fDel').textContent = t.footer_del;
      document.getElementById('fPriv').textContent = t.footer_priv;

      const btn = document.getElementById('langToggle');
      btn.querySelector('.ru').classList.toggle('active', l==='ru');
      btn.querySelector('.ky').classList.toggle('active', l==='ky');

      render();
    }
    document.getElementById('langToggle').addEventListener('click', ()=>{
      const next = getLang()==='ru' ? 'ky' : 'ru';
      localStorage.setItem('lang', next);
      applyLang(next);
    });

    // ===== utils =====
    const TELEGRAM_URL = 'https://t.me/ArendatorKg_VIP_bot';
    const FAV_KEY = 'arendator:favs';
    const FAV_CACHE_KEY = 'arendator:favcache';
    const API_LIMIT = 200;
    const API_URL = (from=0,limit=API_LIMIT)=>`/api/listings?from=${from}&limit=${limit}`;
    const qs = (s,el=document)=>el.querySelector(s);
    const showToast=(m)=>{const t=qs('#toast'); t.textContent=m; t.classList.remove('hidden'); clearTimeout(showToast.t); showToast.t=setTimeout(()=>t.classList.add('hidden'),1800);};

    function normalizeListings(payload){
      if(Array.isArray(payload)) return payload;
      if(payload && Array.isArray(payload.items)) return payload.items;
      if(payload && Array.isArray(payload.data))  return payload.data;
      if(payload && payload.items && Array.isArray(payload.items.items)) return payload.items.items;
      return [];
    }
    function getPhotos(raw){
      if(!raw) return [];
      if(Array.isArray(raw)) return raw;
      if(typeof raw==='string'){
        try{ const v=JSON.parse(raw); return Array.isArray(v)?v:[]; }catch{return [];}
      }
      return [];
    }
    function toUrlString(p){
      if(typeof p === 'string') return p;
      if(p && typeof p === 'object'){
        return p.url || p.src || p.href || p.path || p.original || p.large || p.medium || p.small || '';
      }
      return '';
    }
    function escapeHtml(s){return String(s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
    function fmtPrice(value, price_text){
      const t = I18N[getLang()];
      const v = (value ?? price_text);
      if(v===null||v===undefined||v==='') return t.price_contract;
      const n = Number(v);
      return isFinite(n) ? n.toLocaleString(getLang()==='ru'?'ru-RU':'ky-KG') + t.currency : escapeHtml(String(v));
    }

    // --- placeholder detection (бережная) ---
    const PLACEHOLDER_RXES = [
      /no[-_ ]?photo/i,
      /no[-_ ]?image/i,
      /nophoto/i,
      /noimage/i,
      /placeholder/i,
      /stub/i,
      /empty/i,
      /default(\.(png|jpg|jpeg|webp|gif))?$/i
    ];
    function isPlaceholderGeneric(url){
      return PLACEHOLDER_RXES.some(rx => rx.test(url));
    }
    function isLalafoPromo(url){
      try{
        const u = new URL(url);
        if(!/lalafo\./i.test(u.hostname)) return false;
        const p = u.pathname.toLowerCase();
        // промо/статические ассеты приложения – НЕ реальные фото объявлений
        const looksPromo = /(app|promo|marketing|landing|static)/.test(p);
        const looksReal  = /(poster|posters|photo|photos|img|image|images|files)/.test(p);
        return looksPromo && !looksReal;
      }catch{ return false; }
    }
    function isPlaceholderPhoto(url){
      if(!url) return true;
      const s = String(url);
      return isPlaceholderGeneric(s) || isLalafoPromo(s);
    }

    // ===== storage =====
    function readFavIds(){
      const a = new Set(JSON.parse(localStorage.getItem(FAV_KEY)||'[]'));
      const b = new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
      return [...new Set([...a, ...b])].map(String);
    }
    function writeFavIds(ids){
      localStorage.setItem(FAV_KEY, JSON.stringify(ids));
      localStorage.setItem('favs', JSON.stringify(ids));
    }
    function readFavCache(){ try{ return JSON.parse(localStorage.getItem(FAV_CACHE_KEY)||'{}'); }catch{ return {}; } }
    function writeFavCache(obj){ localStorage.setItem(FAV_CACHE_KEY, JSON.stringify(obj)); }

    // ===== fetch missing cards =====
    async function fetchByIdsIfMissing(idsMissing){
      if(!idsMissing.length) return {};
      const found = {};
      let from = 0, guard = 0;
      while(guard++ < 6){
        try{
          const res = await fetch(API_URL(from, API_LIMIT), {cache:'no-store'});
          if(!res.ok) break;
          const page = normalizeListings(await res.json());
          if(!page.length) break;
          for(const item of page){
            const sid = String(item.id);
            if(idsMissing.includes(sid) && !found[sid]){
              found[sid] = {
                id: sid,
                title: item.title || '—',
                price: item.price ?? null,
                price_text: item.price_text ?? null,
                district: item.district || '',
                photos: getPhotos(item.photos).map(toUrlString).filter(Boolean).slice(0,6),
              };
            }
          }
          if(Object.keys(found).length === idsMissing.length) break;
          from += page.length;
        }catch(_){ break; }
      }
      return found;
    }

    // ===== card =====
    function cardHTML(it){
      const t = I18N[getLang()];
      const photos = getPhotos(it.photos).map(toUrlString).filter(Boolean);

      // первая НЕ-плейсхолдерная картинка
      const firstReal = photos.find(u => !isPlaceholderPhoto(u));
      const img = firstReal || '';

      const title = escapeHtml(it.title||'—');
      const price = fmtPrice(it.price, it.price_text);
      const district = escapeHtml(it.district || '');
      return `
      <article class="rounded-2xl border border-neutral-200 bg-white overflow-hidden shadow-sm hover:shadow-md transition-shadow flex flex-col h-full">
        <div class="aspect-[4/3] overflow-hidden grid place-items-center bg-neutral-100">
          ${img ? `<img src="${img}" alt="${title}" class="w-full h-full object-cover" loading="lazy">`
                 : `<div class="ph-wrap"><div class="ph-text">${t.no_photo}</div></div>`}
        </div>
        <div class="p-3 sm:p-4 flex-1 flex flex-col gap-3">
          <h3 class="font-semibold leading-snug text-sm sm:text-base">${title}</h3>
          <div class="text-lg sm:text-2xl font-bold">${price}</div>
          <div class="text-[12px] sm:text-sm text-neutral-600">${district}</div>
          <div class="mt-auto grid grid-cols-1 gap-2">
            <a class="px-3 py-2 rounded-xl bg-blue-600 text-white text-sm text-center hover:bg-blue-700 inline-flex items-center justify-center"
               href="${TELEGRAM_URL}" target="_blank" rel="noopener">
              <span class="tg-ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9.999 15.2 9.9 19c.4 0 .6-.2.8-.4l1.9-1.8 4.1 3c.8.4 1.4.2 1.6-.8l2.9-13.5c.3-1.3-.5-1.8-1.3-1.5L2.5 9.4c-1.3.5-1.3 1.2-.2 1.5л4.6 1.4L18.9 6c.7-.4 1.3-.2 .8.2"/></svg>
              </span>
              ${t.tg_btn}
            </a>
            <button class="unfav-btn text-xs text-neutral-600 justify-self-end hover:text-red-600 inline-flex items-center gap-1" data-id="${it.id}">
              <span class="text-red-600">❤</span> ${t.remove}
            </button>
          </div>
        </div>
      </article>`;
    }

    // ===== render =====
    async function render(){
      const t = I18N[getLang()];
      const favIds = readFavIds();
      const grid = qs('#grid');
      const empty = qs('#empty');

      if (!favIds.length){
        empty.classList.remove('hidden');
        grid.innerHTML = '';
        return;
      }
      empty.classList.add('hidden');

      const cache = readFavCache();
      const missing = favIds.filter(id => !cache[id]);
      if(missing.length){
        const fetched = await fetchByIdsIfMissing(missing);
        if(Object.keys(fetched).length){
          Object.assign(cache, fetched);
          writeFavCache(cache);
        }
      }

      const items = favIds.map(id=>cache[id]).filter(Boolean);
      grid.innerHTML = items.map(cardHTML).join('');

      grid.querySelectorAll('.unfav-btn').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = String(b.dataset.id);
          const set = new Set(readFavIds());
          const cacheNow = readFavCache();
          set.delete(id);
          delete cacheNow[id];
          writeFavIds([...set]);
          writeFavCache(cacheNow);
          showToast(t.toast_removed);
          render();
        });
      });
    }

    // ===== init =====
    (function initContact(){
      const ts = document.getElementById('tsField'); if (ts) ts.value = Date.now();
      const form = document.getElementById('contactForm');
      const note = document.getElementById('contactNote');
      if (!form) return;
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const t = I18N[getLang()];
        const fd = new FormData(form);
        const payload = Object.fromEntries(fd.entries());
        if (payload.website && payload.website.trim() !== '') { form.reset(); if (note) note.textContent=t.sent_ok; return; }
        payload.to = 'reply@arendator.kg';
        try{
          const res = await fetch('/api/send-mail', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const data = await res.json();
          if (data.ok){ form.reset(); if (note) note.textContent=t.sent_ok; if (ts) ts.value=Date.now(); }
          else { if (note) note.textContent= t.sent_err; }
        }catch{ if (note) note.textContent=t.net_err; }
      });
    })();

    document.addEventListener('DOMContentLoaded', ()=>{
      const lang = getLang();
      localStorage.setItem('lang', lang);
      applyLang(lang);
    });
  </script>
</body>
</html>
