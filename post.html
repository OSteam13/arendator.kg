<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Добавить объявление | Arendator.kg</title>
  <meta name="description" content="Добавьте объявление об аренде квартиры в Бишкеке — фото, описание, цена.">
  <link rel="icon" href="./images/Arendatorkg.png">
  <link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--container:1180px}
    .container{max-width:var(--container)}
    html,body{overflow-x:hidden;font-family:'Onest',system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    .shadow-soft{box-shadow:0 8px 30px rgba(0,0,0,.08)}
    .hero-title{font-weight:800}
    .lang-toggle{padding:.25rem .5rem;border:1px solid rgb(229 231 235);border-radius:.75rem}
    .lang-toggle span{opacity:.55}
    .lang-toggle .active{opacity:1;font-weight:700}
    .card{transition:box-shadow .2s ease}
    .card:hover{box-shadow:0 10px 30px rgba(0,0,0,.08)}
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900">

  <!-- верхняя полоса -->
  <div class="bg-emerald-600 text-white text-center text-xs sm:text-sm py-2">
    Объявления живут 24 часа · Анти-агент фильтр включён · Контакты — в Telegram
  </div>

  <!-- Шапка как на главной -->
  <header class="bg-white sticky top-0 z-30 border-b border-neutral-100/80">
    <div class="container mx-auto px-4 py-2 md:py-3">
      <div class="flex flex-wrap items-center gap-3">
        <!-- Лого -->
        <a href="index.html" class="order-1 flex items-center gap-2 shrink-0">
          <img src="./images/Arendatorkg.png" alt="Arendator.kg" class="w-8 h-8 rounded-full object-contain">
          
        </a>

        <!-- Навигация: мобайл — 3 колонки, ПК — в одну строку -->
        <nav class="order-3 w-full mt-2 grid grid-cols-3 gap-2 text-sm
                    md:order-2 md:w-auto md:mt-0 md:grid-cols-none md:flex md:flex-1 md:justify-center md:gap-3">
          <a href="blog.html" class="w-full px-3 py-1.5 text-center rounded-xl border border-neutral-200 hover:bg-neutral-50">Блог</a>
          <a href="post.html" class="w-full px-3 py-1.5 text-center rounded-xl bg-neutral-900 text-white hover:bg-neutral-800">Добавить объявление</a>
          <a href="favorites.html" class="w-full px-3 py-1.5 text-center rounded-xl border border-neutral-200 hover:bg-neutral-50">Избранное</a>
        </nav>

        <!-- Переключатель языка -->
        <button id="langToggle" class="order-2 md:order-3 ml-auto lang-toggle text-sm" type="button">
          <span class="ru active">Рус</span> / <span class="ky">Кыр</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Герой -->
  <section class="container mx-auto px-4 pt-8 pb-6">
    <div class="rounded-2xl bg-white border border-neutral-200 shadow-soft p-5 md:p-8">
      <h1 class="hero-title text-3xl md:text-4xl leading-tight text-blue-600">Добавить объявление</h1>
      <p class="mt-2 text-neutral-700">Заполните форму, прикрепите 1–8 фото. Объявление сохранится локально и появится в ленте на главной.</p>
    </div>
  </section>

  <!-- Форма + предпросмотр -->
  <section class="container mx-auto px-4 pb-10">
    <div class="grid lg:grid-cols-2 gap-6">
      <!-- Форма -->
      <form id="postForm" class="rounded-2xl bg-white border border-neutral-200 shadow-soft p-5 grid gap-3">
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-neutral-600">Тип</label>
            <select id="fType" class="mt-1 w-full px-3 py-2 rounded-xl border border-neutral-200">
              <option value="Квартира">Квартира</option>
              <option value="Комната">Комната</option>
              <option value="Дом">Дом</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-neutral-600">Комнат</label>
            <select id="fRooms" class="mt-1 w-full px-3 py-2 rounded-xl border border-neutral-200">
              <option>1</option><option>2</option><option>3</option><option>3+</option>
            </select>
          </div>
        </div>

        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-neutral-600">Район / локация</label>
            <input id="fDistrict" placeholder="Центр, Асанбай, Восток-5…" class="mt-1 w-full px-3 py-2 rounded-xl border border-neutral-200">
          </div>
          <div>
            <label class="text-sm text-neutral-600">Цена (сом/мес или сом/сут)</label>
            <input id="fPrice" type="number" min="0" placeholder="35000" class="mt-1 w-full px-3 py-2 rounded-xl border border-neutral-200">
          </div>
        </div>

        <div>
          <label class="text-sm text-neutral-600">Заголовок</label>
          <input id="fTitle" maxlength="80" placeholder="2к, Центр, свежий ремонт" class="mt-1 w-full px-3 py-2 rounded-xl border border-neutral-200">
        </div>

        <div>
          <label class="text-sm text-neutral-600">Описание</label>
          <textarea id="fDesc" rows="4" placeholder="Кратко опишите состояние, мебель, условия…" class="mt-1 w-full px-3 py-2 rounded-xl border border-neutral-200"></textarea>
        </div>

        <div class="grid sm:grid-cols-2 gap-3">
          <label class="inline-flex items-center gap-2">
            <input id="fDaily" type="checkbox"> <span>Посуточно</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input id="fOwner" type="checkbox" checked> <span>Я владелец (без посредников)</span>
          </label>
        </div>

        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-neutral-600">Телефон для связи</label>
            <input id="fPhone" placeholder="+996 555 123-456" class="mt-1 w-full px-3 py-2 rounded-xl border border-neutral-200">
          </div>
          <div>
            <label class="text-sm text-neutral-600">Фото (1–8)</label>
            <input id="fPhotos" type="file" accept="image/*" multiple class="mt-1 w-full px-3 py-2 rounded-xl border border-neutral-200">
          </div>
        </div>

        <div id="photoPreview" class="mt-1 grid grid-cols-3 sm:grid-cols-4 gap-2"></div>

        <div class="grid sm:grid-cols-2 gap-3 pt-2">
          <button type="submit" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Опубликовать</button>
          <button id="btnClear" type="button" class="px-4 py-2 rounded-xl border border-neutral-200 hover:bg-neutral-50">Сбросить</button>
        </div>
        <div id="note" class="text-xs text-neutral-500"></div>
      </form>

      <!-- Превью карточки -->
      <aside class="rounded-2xl bg-white border border-neutral-200 shadow-soft p-5">
        <h2 class="font-semibold mb-3">Предпросмотр</h2>
        <div id="previewCard" class="card rounded-2xl border border-neutral-200 bg-white overflow-hidden">
          <div class="aspect-[4/3] bg-neutral-100 grid place-items-center text-neutral-500">Фото</div>
          <div class="p-4 space-y-3">
            <div class="flex items-start gap-2">
              <h3 class="font-semibold leading-snug" id="pTitle">Заголовок</h3>
              <span class="ml-auto inline-flex items-center text-xs px-2 py-1 rounded-full whitespace-nowrap bg-emerald-100 text-emerald-700" id="pOwner">Без посредников</span>
            </div>
            <div class="text-2xl font-bold" id="pPrice">0 <span class="text-sm font-medium text-neutral-500">сом/мес</span></div>
            <div class="flex items-center gap-2 text-sm text-neutral-600"><div id="pDistrict">Район</div><div>·</div><div>Комнат: <span id="pRooms">1</span></div></div>
            <div class="grid grid-cols-1">
              <span class="px-3 py-2 rounded-xl bg-blue-600 text-white text-sm text-center">Номер в Telegram</span>
            </div>
          </div>
        </div>
        <p class="text-xs text-neutral-500 mt-3">* На главной карточка будет выглядеть так же.</p>
      </aside>
    </div>
  </section>

  <footer class="border-t border-neutral-100 bg-white">
    <div class="container mx-auto px-4 py-6 text-xs text-neutral-500 text-center">© 2025 — Arendator.kg</div>
  </footer>

  <script>
    // Мини-переключатель языка (только подписи навигации).
    (function(){
      const btn = document.getElementById('langToggle');
      const set = (lang) => {
        btn.querySelector('.ru').classList.toggle('active', lang==='ru');
        btn.querySelector('.ky').classList.toggle('active', lang==='ky');
        const nav = document.querySelector('header nav'); if (!nav) return;
        const labels = { ru: ['Блог','Добавить объявление','Избранное'], ky:['Блог','Жарна кошуу','Тандалгандар'] };
        const [blog,add,fav] = labels[lang];
        nav.children[0].textContent = blog;
        nav.children[1].textContent = add;
        nav.children[2].textContent = fav;
      };
      let cur = localStorage.getItem('lang') || 'ru';
      set(cur);
      btn.addEventListener('click', ()=>{ cur = (cur==='ru'?'ky':'ru'); localStorage.setItem('lang',cur); set(cur); });
    })();

    // ======= УТИЛИТЫ =======
    const qs = (s,el=document)=>el.querySelector(s);
    const qsa = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const escapeHtml = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const note = (m)=>{ const n=qs('#note'); if(n) n.textContent=m||''; };

    // ======= ПРЕДПРОСМОТР =======
    const f = {
      type: qs('#fType'), rooms: qs('#fRooms'), district: qs('#fDistrict'), price: qs('#fPrice'),
      title: qs('#fTitle'), desc: qs('#fDesc'), daily: qs('#fDaily'), owner: qs('#fOwner'),
      phone: qs('#fPhone'), photos: qs('#fPhotos')
    };
    const pv = { title:qs('#pTitle'), price:qs('#pPrice'), rooms:qs('#pRooms'), district:qs('#pDistrict'), owner:qs('#pOwner') };

    function refreshPreview(firstImg){
      const price = Number(f.price.value||0);
      const unit = f.daily.checked ? 'сом/сут' : 'сом/мес';
      pv.title.textContent = f.title.value.trim() || 'Заголовок';
      pv.price.innerHTML   = (price? price.toLocaleString('ru-RU') : '0') + ` <span class="text-sm font-medium text-neutral-500">${unit}</span>`;
      pv.rooms.textContent = f.rooms.value || '1';
      pv.district.textContent = f.district.value.trim() || 'Район';
      pv.owner.textContent = f.owner.checked ? 'Без посредников' : 'Источник';
      if (firstImg){
        const box = qs('#previewCard .aspect-\\[4\\/3\\]');
        box.innerHTML = `<img src="${firstImg}" alt="Фото" class="w-full h-full object-cover">`;
      }
    }
    ['change','input'].forEach(evt=>{
      qsa('#postForm input, #postForm select, #postForm textarea').forEach(el=>el.addEventListener(evt, ()=>refreshPreview()));
    });

    // ======= ФОТО: загрузка и компрессия =======
    const photoPreview = qs('#photoPreview');
    let photoDataUrls = []; // dataURL[]

    async function fileToDataURL(file, maxSide=1600, quality=0.85){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=>{
          const scale = Math.min(1, maxSide/Math.max(img.width, img.height));
          const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
          const c = document.createElement('canvas'); c.width = w; c.height = h;
          const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
          resolve(c.toDataURL('image/jpeg', quality));
        };
        img.onerror = reject;
        const r = new FileReader();
        r.onload = ()=>{ img.src = r.result; };
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    f.photos.addEventListener('change', async (e)=>{
      photoPreview.innerHTML = '';
      photoDataUrls = [];
      const files = Array.from(e.target.files||[]).slice(0,8);
      for (const file of files){
        try{
          const url = await fileToDataURL(file);
          photoDataUrls.push(url);
          const el = document.createElement('img');
          el.src = url; el.className='w-full h-24 object-cover rounded-lg border border-neutral-200';
          photoPreview.appendChild(el);
        }catch(_){}
      }
      refreshPreview(photoDataUrls[0]);
    });

    // ======= ХРАНИЛИЩЕ =======
    function getUserListings(){
      try{ return JSON.parse(localStorage.getItem('user_listings')||'[]'); }catch{ return []; }
    }
    function setUserListings(arr){
      try{ localStorage.setItem('user_listings', JSON.stringify(arr)); }catch(_){}
    }

    // ======= ВАЛИДАЦИЯ =======
    function validate(){
      const errs = [];
      if (!f.title.value.trim()) errs.push('Укажите заголовок');
      if (!f.district.value.trim()) errs.push('Укажите район/локацию');
      const price = Number(f.price.value||0);
      if (!(price>0)) errs.push('Укажите корректную цену');
      if (!f.phone.value.trim()) errs.push('Укажите телефон');
      if (photoDataUrls.length===0) errs.push('Добавьте хотя бы одно фото');
      return errs;
    }

    // ======= SUBMIT =======
    qs('#postForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const errs = validate();
      if (errs.length){ note(errs.join(' · ')); return; }
      note('');

      const item = {
        id: 'u'+Date.now(),
        title: f.title.value.trim(),
        price: Number(f.price.value||0),
        district: f.district.value.trim(),
        rooms: f.rooms.value,
        daily: !!f.daily.checked,
        owner: !!f.owner.checked,
        phone: f.phone.value.trim(),
        desc: f.desc.value.trim(),
        img: photoDataUrls[0] || '',
        photos: photoDataUrls.slice(0,8),
        createdAt: Date.now()
      };

      const list = getUserListings();
      list.unshift(item);
      setUserListings(list);

      try{ localStorage.setItem('flash_msg','Объявление добавлено'); }catch(_){}

      // редирект на главную
      location.href = '/';
    });

    qs('#btnClear').addEventListener('click', ()=>{
      qs('#postForm').reset();
      photoPreview.innerHTML = '';
      photoDataUrls = [];
      const box = qs('#previewCard .aspect-\\[4\\/3\\]');
      box.innerHTML = 'Фото';
      refreshPreview();
    });

    // стартовый превью
    refreshPreview();
  </script>
</body>
</html>
