<script>
  // Мини-переключатель языка (только подписи навигации).
  (function(){
    const btn = document.getElementById('langToggle');
    const set = (lang) => {
      btn.querySelector('.ru').classList.toggle('active', lang==='ru');
      btn.querySelector('.ky').classList.toggle('active', lang==='ky');
      const nav = document.querySelector('header nav'); if (!nav) return;
      const labels = { ru: ['Блог','Добавить объявление','Избранное'], ky:['Блог','Жарна кошуу','Тандалгандар'] };
      const [blog,add,fav] = labels[lang];
      nav.children[0].textContent = blog;
      nav.children[1].textContent = add;
      nav.children[2].textContent = fav;
    };
    let cur = localStorage.getItem('lang') || 'ru';
    set(cur);
    btn.addEventListener('click', ()=>{ cur = (cur==='ru'?'ky':'ru'); localStorage.setItem('lang',cur); set(cur); });
  })();

  // ======= УТИЛИТЫ =======
  const qs = (s,el=document)=>el.querySelector(s);
  const qsa = (s,el=document)=>Array.from(el.querySelectorAll(s));
  const escapeHtml = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const note = (m)=>{ const n=qs('#note'); if(n) n.textContent=m||''; };

  // ======= ПРЕДПРОСМОТР =======
  const f = {
    type: qs('#fType'), rooms: qs('#fRooms'), district: qs('#fDistrict'), price: qs('#fPrice'),
    title: qs('#fTitle'), desc: qs('#fDesc'), daily: qs('#fDaily'), owner: qs('#fOwner'),
    phone: qs('#fPhone'), photos: qs('#fPhotos')
  };
  const pv = { title:qs('#pTitle'), price:qs('#pPrice'), rooms:qs('#pRooms'), district:qs('#pDistrict'), owner:qs('#pOwner') };

  function refreshPreview(firstImg){
    const price = Number(f.price.value||0);
    const unit = f.daily.checked ? 'сом/сут' : 'сом/мес';
    pv.title.textContent = f.title.value.trim() || 'Заголовок';
    pv.price.innerHTML   = (price? price.toLocaleString('ru-RU') : '0') + ` <span class="text-sm font-medium text-neutral-500">${unit}</span>`;
    pv.rooms.textContent = f.rooms.value || '1';
    pv.district.textContent = f.district.value.trim() || 'Район';
    pv.owner.textContent = f.owner.checked ? 'Без посредников' : 'Источник';
    if (firstImg){
      const box = qs('#previewCard .aspect-\\[4\\/3\\]');
      box.innerHTML = `<img src="${firstImg}" alt="Фото" class="w-full h-full object-cover">`;
    }
  }
  ['change','input'].forEach(evt=>{
    qsa('#postForm input, #postForm select, #postForm textarea').forEach(el=>el.addEventListener(evt, ()=>refreshPreview()));
  });

  // ======= ФОТО: загрузка и компрессия =======
  const photoPreview = qs('#photoPreview');
  let photoDataUrls = []; // dataURL[]

  async function fileToDataURL(file, maxSide=1600, quality=0.85){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = ()=>{
        const scale = Math.min(1, maxSide/Math.max(img.width, img.height));
        const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
        const c = document.createElement('canvas'); c.width = w; c.height = h;
        const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
        resolve(c.toDataURL('image/jpeg', quality));
      };
      img.onerror = reject;
      const r = new FileReader();
      r.onload = ()=>{ img.src = r.result; };
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  f.photos.addEventListener('change', async (e)=>{
    photoPreview.innerHTML = '';
    photoDataUrls = [];
    const files = Array.from(e.target.files||[]).slice(0,8);
    for (const file of files){
      try{
        const url = await fileToDataURL(file);
        photoDataUrls.push(url);
        const el = document.createElement('img');
        el.src = url; el.className='w-full h-24 object-cover rounded-lg border border-neutral-200';
        photoPreview.appendChild(el);
      }catch(_){}
    }
    refreshPreview(photoDataUrls[0]);
  });

  // ======= ХРАНИЛИЩЕ =======
  function getUserListings(){
    try{ return JSON.parse(localStorage.getItem('user_listings')||'[]'); }catch{ return []; }
  }
  function setUserListings(arr){
    try{ localStorage.setItem('user_listings', JSON.stringify(arr)); }catch(_){}
  }

  // ======= ВАЛИДАЦИЯ =======
  function validate(){
    const errs = [];
    if (!f.title.value.trim()) errs.push('Укажите заголовок');
    if (!f.district.value.trim()) errs.push('Укажите район/локацию');
    const price = Number(f.price.value||0);
    if (!(price>0)) errs.push('Укажите корректную цену');
    if (!f.phone.value.trim()) errs.push('Укажите телефон');
    if (photoDataUrls.length===0) errs.push('Добавьте хотя бы одно фото');
    return errs;
  }

  // ======= SUBMIT =======
  qs('#postForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const errs = validate();
    if (errs.length){ note(errs.join(' · ')); return; }
    note('');

    const item = {
      id: 'u'+Date.now(),
      title: f.title.value.trim(),
      price: Number(f.price.value||0),
      price_text: null,               // на главной тоже корректно отобразится
      district: f.district.value.trim(),
      rooms: f.rooms.value,
      daily: !!f.daily.checked,
      owner: !!f.owner.checked,
      phone: f.phone.value.trim(),
      desc: f.desc.value.trim(),
      img: photoDataUrls[0] || '',
      photos: photoDataUrls.slice(0,8),
      createdAt: Date.now()
    };

    const list = getUserListings();
    list.unshift(item);
    setUserListings(list);

    try{ localStorage.setItem('flash_msg','Объявление добавлено'); }catch(_){}

    // ✅ важно: переадресуем на реальный файл главной, чтобы лента сразу подхватила локальные объявления
    location.href = 'index.html#feed';
  });

  qs('#btnClear').addEventListener('click', ()=>{
    qs('#postForm').reset();
    photoPreview.innerHTML = '';
    photoDataUrls = [];
    const box = qs('#previewCard .aspect-\\[4\\/3\\]');
    box.innerHTML = 'Фото';
    refreshPreview();
  });

  // стартовый превью
  refreshPreview();
</script>
